import React from 'react';
import { Button } from '@/components/ui/button';
import { Download } from 'lucide-react';

export default function ExportGPS({ marketData }) {
  const generateHTML = () => {
    const latestData = marketData[0] || { risk_score: 0, safety_score: 0 };
    const chartData = marketData
      .slice(0, 20)
      .reverse()
      .map(d => ({
        time: new Date(d.timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
        risk: d.risk_score.toFixed(1),
        safety: d.safety_score.toFixed(1),
      }));

    const html = `<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS de Mercado - ${new Date().toLocaleDateString('pt-BR')}</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 50%, #0f172a 100%);
            color: white;
            padding: 20px;
            min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { text-align: center; font-size: 2.5rem; margin-bottom: 30px; }
        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 24px;
        }
        .card h2 { font-size: 1.25rem; margin-bottom: 16px; }
        .score { font-size: 2.5rem; font-weight: bold; margin-bottom: 8px; }
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-left: 8px;
        }
        .badge.up { background: #10b981; }
        .badge.down { background: #ef4444; }
        .badge.neutral { background: #6b7280; }
        .chart-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
        }
        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            opacity: 0.7;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä GPS de Mercado</h1>
        
        <div class="cards">
            <div class="card">
                <h2>üìà Ativos de Risco
                    <span class="badge ${latestData.risk_score > 0 ? 'up' : latestData.risk_score < 0 ? 'down' : 'neutral'}">
                        ${latestData.risk_score > 0 ? 'Alta' : latestData.risk_score < 0 ? 'Queda' : 'Neutro'}
                    </span>
                </h2>
                <div class="score">${latestData.risk_score.toFixed(1)}</div>
                <p style="opacity: 0.8; font-size: 0.875rem;">Se subir: Ibov sobe, D√≥lar cai</p>
            </div>
            
            <div class="card">
                <h2>üõ°Ô∏è Ativos de Seguran√ßa
                    <span class="badge ${latestData.safety_score > 0 ? 'up' : latestData.safety_score < 0 ? 'down' : 'neutral'}">
                        ${latestData.safety_score > 0 ? 'Alta' : latestData.safety_score < 0 ? 'Queda' : 'Neutro'}
                    </span>
                </h2>
                <div class="score">${latestData.safety_score.toFixed(1)}</div>
                <p style="opacity: 0.8; font-size: 0.875rem;">Se subir: Ibov cai, D√≥lar sobe</p>
            </div>
        </div>
        
        <div class="chart-container">
            <h2 style="margin-bottom: 20px;">Evolu√ß√£o Comparativa</h2>
            <canvas id="marketChart"></canvas>
        </div>
        
        <div class="footer">
            Atualizado em: ${new Date().toLocaleString('pt-BR')}<br>
            GPS de Mercado - An√°lise de Ativos de Risco vs Seguran√ßa
        </div>
    </div>
    
    <script>
        const ctx = document.getElementById('marketChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: ${JSON.stringify(chartData.map(d => d.time))},
                datasets: [
                    {
                        label: 'Ativos de Risco',
                        data: ${JSON.stringify(chartData.map(d => d.risk))},
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Ativos de Seguran√ßa',
                        data: ${JSON.stringify(chartData.map(d => d.safety))},
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        labels: { color: 'white', font: { size: 14 } }
                    }
                },
                scales: {
                    y: {
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: { color: 'white' }
                    },
                    x: {
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: { color: 'white' }
                    }
                }
            }
        });
    </script>
</body>
</html>`;

    return html;
  };

  const downloadHTML = () => {
    const html = generateHTML();
    const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `gps-mercado-${new Date().toISOString().split('T')[0]}.html`;
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    setTimeout(() => {
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }, 100);
  };

  return (
    <Button onClick={downloadHTML} variant="outline" className="bg-white/10 border-white/20 text-white hover:bg-white/20">
      <Download className="w-4 h-4 mr-2" />
      Baixar HTML
    </Button>
  );
}
