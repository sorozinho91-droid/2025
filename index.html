<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Dashboard – Comparação de Ativos com Destaque</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
body { font-family: Arial, sans-serif; margin: 0; background: #f4f6f8; }
header { background: #1f2937; color: white; padding: 15px; text-align: center; }
#controls, #date-controls { text-align: center; padding: 10px; }
button { margin: 5px; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; background: #e5e7eb; }
button.active { background: #2563eb; color: white; }
#grafico { width: 100%; height: 600px; }
input[type="date"] { margin: 0 5px; padding: 5px; }
#intervaloSelecionado { text-align: center; margin: 10px; font-weight: bold; }
</style>
</head>
<body>

<header>
<h2>Ativos de Risco x Seguros – Comparação por Datas</h2>
</header>

<div id="controls">
<button onclick="setTimeframe(0.5, this)">30s</button>
<button onclick="setTimeframe(1, this)" class="active">1m</button>
<button onclick="setTimeframe(5, this)">5m</button>
<button onclick="setTimeframe(15, this)">15m</button>
<button onclick="setTimeframe(60, this)">1h</button>
</div>

<div id="date-controls">
<label>Data inicial: <input type="date" id="startDate"></label>
<label>Data final: <input type="date" id="endDate"></label>
<button onclick="filtrarDatas()">Comparar</button>
<button onclick="removerFiltro()">Remover Filtro</button>
</div>

<div id="intervaloSelecionado"></div>
<div id="grafico"></div>

<script>
let timeframe = 1;
let timer = null;
let emTempoReal = true;

let datas = [], risco = [], seguro = [];
let valorRisco = 100, valorSeguro = 100;

function atualizarValores(valor, vol){
    return Math.max(0, valor + (Math.random()-0.5)*vol);
}

function gerarHistoricoAnual(anos=1){
    const hoje = new Date();
    const start = new Date(hoje.getFullYear()-anos, hoje.getMonth(), hoje.getDate());
    let valR = 100, valS = 100;
    datas = []; risco = []; seguro = [];
    for(let d = new Date(start); d <= hoje; d.setDate(d.getDate()+1)){
        valR = atualizarValores(valR,2);
        valS = atualizarValores(valS,0.5);
        datas.push(new Date(d));
        risco.push(valR);
        seguro.push(valS);
    }
    valorRisco = valR; valorSeguro = valS;
}

function atualizarGrafico(){
    if(!emTempoReal) return;
    const agora = new Date();
    valorRisco = atualizarValores(valorRisco,2);
    valorSeguro = atualizarValores(valorSeguro,0.5);
    datas.push(agora);
    risco.push(valorRisco);
    seguro.push(valorSeguro);
    Plotly.extendTraces('grafico', {x:[[agora],[agora]], y:[[valorRisco],[valorSeguro]]}, [0,1]);
}

function setTimeframe(minutos, botao){
    timeframe = minutos;
    document.querySelectorAll('#controls button').forEach(b=>b.classList.remove('active'));
    botao.classList.add('active');
    if(timer) clearInterval(timer);
    timer = setInterval(atualizarGrafico, timeframe*60000);
}

function filtrarDatas(){
    const startInput = document.getElementById('startDate').value;
    const endInput = document.getElementById('endDate').value;
    if(!startInput || !endInput){ alert('Selecione ambas as datas'); return; }
    const start = new Date(startInput + 'T00:00:00');
    const end = new Date(endInput + 'T23:59:59');
    if(start > end){ alert('Data inicial maior que final'); return; }

    emTempoReal = false;

    const filteredX = [], filteredR = [], filteredS = [];
    for(let i=0;i<datas.length;i++){
        if(datas[i]>=start && datas[i]<=end){
            filteredX.push(datas[i]);
            filteredR.push(risco[i]);
            filteredS.push(seguro[i]);
        }
    }

    Plotly.update('grafico',{x:[filteredX, filteredX], y:[filteredR, filteredS]});
    Plotly.relayout('grafico', {
        'xaxis.range':[start,end],
        'xaxis.tickformat':'%d/%m',
        shapes: [{
            type: 'rect',
            xref: 'x',
            yref: 'paper',
            x0: start,
            x1: end,
            y0: 0,
            y1: 1,
            fillcolor: 'rgba(200,200,255,0.2)',
            line: {width:0}
        }]
    });

    document.getElementById('intervaloSelecionado').innerText =
        `Comparação do período: ${start.toLocaleDateString()} até ${end.toLocaleDateString()}`;
}

function removerFiltro(){
    emTempoReal = true;
    document.getElementById('intervaloSelecionado').innerText='';
    Plotly.update('grafico',{x:[datas,datas], y:[risco,seguro]});
    Plotly.relayout('grafico',{'xaxis.autorange':true,'xaxis.tickformat':null,'shapes':[]});
}

/* Inicialização */
gerarHistoricoAnual(1);

const layout = {
    title:'Comparação de Ativos',
    xaxis:{title:'Data', type:'date'},
    yaxis:{title:'Valor'},
    margin:{t:50},
    legend: {
        title: { text: '<b>Ativos</b>' },
        x: 1,
        xanchor: 'right',
        y: 1,
        font: {size:14},
        bgcolor: '#f4f6f8',
        bordercolor: '#888',
        borderwidth: 1
    }
};

const traceRisco = {
    x: datas,
    y: risco,
    mode: 'lines+markers',
    name: 'Ativos de Risco',
    line:{color:'red', width:2},
    marker:{size:6, symbol:'circle'},
    hovertemplate: 'Data: %{x|%d/%m/%Y}<br>Valor: %{y:.2f}<extra></extra>'
};

const traceSeguro = {
    x: datas,
    y: seguro,
    mode: 'lines+markers',
    name: 'Ativos Seguros',
    line:{color:'green', width:2},
    marker:{size:6, symbol:'square'},
    hovertemplate: 'Data: %{x|%d/%m/%Y}<br>Valor: %{y:.2f}<extra></extra>'
};

Plotly.newPlot('grafico',[traceRisco, traceSeguro], layout, {responsive:true});

timer = setInterval(atualizarGrafico, timeframe*60000);
window.addEventListener('resize',()=>{Plotly.Plots.resize('grafico');});
</script>

</body>
</html>
