<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Dashboard de Mercado</title>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 20px;
  background: #f5f5f5;
}

h2, h3 { margin-top: 20px; }

table {
  border-collapse: collapse;
  width: 100%;
  background: #fff;
  margin-bottom: 20px;
  box-shadow: 0 2px 6px rgba(0,0,0,.1);
}

th, td {
  border: 1px solid #ccc;
  padding: 8px;
  text-align: center;
}

th {
  background: #333;
  color: white;
}

td.positivo { color: green; font-weight: bold; }
td.negativo { color: red; font-weight: bold; }

#ultima-atualizacao {
  margin-top: 10px;
  font-weight: bold;
}
</style>
</head>

<body>

<h2>Cotações de Ativos (Alpha Vantage)</h2>

<h3>Segurança</h3>
<table>
<thead>
<tr>
  <th>Ativo</th>
  <th>Último</th>
  <th>Variação</th>
  <th>%</th>
</tr>
</thead>
<tbody>
<tr><td>Ouro</td><td id="gold-price">-</td><td id="gold-change">-</td><td id="gold-percent">-</td></tr>
<tr><td>Dólar (UUP)</td><td id="dxy-price">-</td><td id="dxy-change">-</td><td id="dxy-percent">-</td></tr>
</tbody>
</table>

<h3>Risco</h3>
<table>
<thead>
<tr>
  <th>Ativo</th>
  <th>Último</th>
  <th>Variação</th>
  <th>%</th>
</tr>
</thead>
<tbody>
<tr><td>S&P 500 (SPY)</td><td id="sp-price">-</td><td id="sp-change">-</td><td id="sp-percent">-</td></tr>
<tr><td>Nasdaq (QQQ)</td><td id="nasdaq-price">-</td><td id="nasdaq-change">-</td><td id="nasdaq-percent">-</td></tr>
</tbody>
</table>

<div id="ultima-atualizacao">Última atualização: --:--:--</div>

<h2>Gráfico Intraday</h2>
<div id="grafico" style="height:300px;background:#fff;border-radius:6px;"></div>

<script>
const API_KEY = "d58a789r01qptoar8c7gd58a789r01qptoar8c80";

/* ================= CONFIGURAÇÃO DOS ATIVOS ================= */
const ativos = [
  {
    id: "gold",
    nome: "Ouro",
    url: () =>
      `https://www.alphavantage.co/query?function=COMMODITY_EXCHANGE_RATE&from_symbol=XAU&to_symbol=USD&apikey=${API_KEY}`,
    parser: d =>
      Number(d["Realtime Commodity Exchange Rate"]?.["5. Exchange Rate"])
  },
  {
    id: "dxy",
    nome: "Dólar",
    url: () =>
      `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=UUP&apikey=${API_KEY}`,
    parser: d =>
      Number(d["Global Quote"]?.["05. price"])
  },
  {
    id: "sp",
    nome: "S&P 500",
    url: () =>
      `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=SPY&apikey=${API_KEY}`,
    parser: d =>
      Number(d["Global Quote"]?.["05. price"])
  },
  {
    id: "nasdaq",
    nome: "Nasdaq",
    url: () =>
      `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=QQQ&apikey=${API_KEY}`,
    parser: d =>
      Number(d["Global Quote"]?.["05. price"])
  }
];

let idx = 0;
let ultimoValor = {};
let historico = [];

/* ================= ATUALIZAÇÃO ================= */
async function atualizarAtivo() {
  const ativo = ativos[idx];
  idx = (idx + 1) % ativos.length;

  try {
    const res = await fetch(ativo.url());
    const data = await res.json();
    const last = ativo.parser(data);

    if (!last || isNaN(last)) return;

    const prev = ultimoValor[ativo.id] ?? last;
    const change = last - prev;
    const percent = ((change / prev) * 100).toFixed(2);

    ultimoValor[ativo.id] = last;

    document.getElementById(`${ativo.id}-price`).innerText = last.toFixed(2);
    document.getElementById(`${ativo.id}-change`).innerText = change.toFixed(2);
    document.getElementById(`${ativo.id}-percent`).innerText = percent + "%";

    const cls = change > 0 ? "positivo" : change < 0 ? "negativo" : "";
    document.getElementById(`${ativo.id}-change`).className = cls;
    document.getElementById(`${ativo.id}-percent`).className = cls;

    historico.push({
      hora: new Date().toLocaleTimeString(),
      valor: last
    });

    Plotly.react("grafico", [{
      x: historico.map(p => p.hora),
      y: historico.map(p => p.valor),
      type: "scatter",
      mode: "lines+markers",
      name: ativo.nome
    }], {
      title: "Evolução Intraday (último ativo)"
    });

    document.getElementById("ultima-atualizacao").innerText =
      "Última atualização: " + new Date().toLocaleTimeString();

  } catch (e) {
    console.error("Erro:", ativo.nome, e);
  }
}

/* ================= START ================= */
atualizarAtivo();
setInterval(atualizarAtivo, 15000); // seguro para Alpha Vantage free
</script>

</body>
</html>
