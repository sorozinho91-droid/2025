import express from 'express';
import fetch from 'node-fetch';
import cors from 'cors';

const app = express();
app.use(cors());
const PORT = process.env.PORT || 3000;

// Insira suas keys em .env
const TWELVE_API_KEY = process.env.TWELVE_API_KEY;
const COMMODITIES_API_KEY = process.env.COMMODITIES_API_KEY;

// Retorna variação percentual de um ativo
function percentChange(current, previous) {
    if (previous == 0) return 0;
    return ((current - previous) / previous * 100).toFixed(2);
}

// DXY (câmbio USD index)
app.get('/api/dxy', async (req, res) => {
    try {
        const r = await fetch(`https://api.twelvedata.com/quote?symbol=DXY&apikey=${TWELVE_API_KEY}`);
        const j = await r.json();
        res.json({ change_pct: parseFloat(j.percent_change).toFixed(2) });
    } catch (e) {
        res.json({ change_pct: 0 });
    }
});

// Petróleo WTI
app.get('/api/oil/wti', async (req, res) => {
    try {
        const r = await fetch(`https://commodities-api.com/api/latest?access_key=${COMMODITIES_API_KEY}&symbols=WTI%20CRUDE%20OIL`);
        const j = await r.json();
        const price = j.rates['WTI CRUDE OIL'];
        const yesterday = price * (1 - Math.random() * 0.02); // Observação: substitua este cálculo pela sua base histórica real
        res.json({ change_pct: percentChange(price, yesterday) });
    } catch (e) {
        res.json({ change_pct: 0 });
    }
});

// Petróleo Brent
app.get('/api/oil/brent', async (req, res) => {
    try {
        const r = await fetch(`https://commodities-api.com/api/latest?access_key=${COMMODITIES_API_KEY}&symbols=BRENT%20CRUDE%20OIL`);
        const j = await r.json();
        const price = j.rates['BRENT CRUDE OIL'];
        const yesterday = price * (1 - Math.random() * 0.02);
        res.json({ change_pct: percentChange(price, yesterday) });
    } catch (e) {
        res.json({ change_pct: 0 });
    }
});

// Minério de Ferro
app.get('/api/iron', async (req, res) => {
    try {
        const r = await fetch(`https://commodities-api.com/api/latest?access_key=${COMMODITIES_API_KEY}&symbols=IRON%20ORE`);
        const j = await r.json();
        const price = j.rates['IRON ORE'];
        const yesterday = price * (1 - Math.random() * 0.02);
        res.json({ change_pct: percentChange(price, yesterday) });
    } catch (e) {
        res.json({ change_pct: 0 });
    }
});

app.listen(PORT, () => console.log(`Backend rodando na porta ${PORT}`));
