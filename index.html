import express from 'express';
import { WebSocketServer } from 'ws';
import fetch from 'node-fetch';
import dotenv from 'dotenv';

dotenv.config();
const app = express();
app.use(express.json());
const PORT = process.env.PORT || 3000;

// Endpoint simples para o frontend carregar HTML
app.use(express.static('public'));

// Criar WebSocket server
const wss = new WebSocketServer({ port: 8080 });

let latestData = {
  dxy: 0,
  wti: 0,
  brent: 0,
  iron: 0
};

// Função simulada para WebSocket real
async function updateData() {
  try {
    // Substitua abaixo com chamadas reais para WebSocket/API de streaming
    latestData.dxy = (Math.random() * 2 - 1).toFixed(2);
    latestData.wti = (Math.random() * 2 - 1).toFixed(2);
    latestData.brent = (Math.random() * 2 - 1).toFixed(2);
    latestData.iron = (Math.random() * 2 - 1).toFixed(2);

    // Envia atualização para todos clientes conectados
    wss.clients.forEach(client => {
      if (client.readyState === 1) { // WebSocket OPEN
        client.send(JSON.stringify(latestData));
      }
    });
  } catch (err) {
    console.error("Erro atualizando dados:", err);
  }
}

// Atualiza dados a cada 1 segundo (simulação)
setInterval(updateData, 1000);

app.listen(PORT, () => console.log(`Backend rodando na porta ${PORT}`));
