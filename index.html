import yfinance as yf
import pandas as pd
import requests
from textblob import TextBlob
import plotly.graph_objects as go
from datetime import datetime, timedelta

# ----------------------------
# 1. Baixar dados históricos do Ibovespa (último mês)
# ----------------------------
ibov = yf.download("^BVSP", period="1mo", interval="1d")

# ----------------------------
# 2. Capturar notícias reais (GNews API)
# ----------------------------
API_KEY = "SUA_CHAVE_API"  # Substitua pela sua chave do GNews

sentimentos_diarios = []

for data in ibov.index:
    data_str = data.strftime('%Y-%m-%d')
    url = f"https://gnews.io/api/v4/search?q=Ibovespa&lang=pt&from={data_str}&to={data_str}&max=5&token={API_KEY}"
    res = requests.get(url).json()
    noticias = [item['title'] for item in res.get('articles', [])]

    if len(noticias) == 0:
        noticias = ["Sem notícias relevantes"]  # fallback

    # Sentimento médio diário
    daily_sentiment = sum(TextBlob(n).sentiment.polarity for n in noticias) / len(noticias)
    sentimentos_diarios.append(daily_sentiment)

ibov['Sentimento'] = sentimentos_diarios

# ----------------------------
# 3. Criar gráfico interativo Plotly
# ----------------------------
fig = go.Figure()

# Linha do Ibovespa
fig.add_trace(go.Scatter(
    x=ibov.index, y=ibov['Close'],
    mode='lines', name='Ibovespa', line=dict(color='blue')
))

# Linha do Sentimento (normalizada para escala do preço)
fig.add_trace(go.Scatter(
    x=ibov.index, y=ibov['Sentimento']*ibov['Close'].max(),
    mode='lines', name='Sentimento', line=dict(color='red', dash='dash')
))

fig.update_layout(
    title='Índice de Sentimento Diário vs Ibovespa',
    xaxis_title='Data',
    yaxis_title='Preço Ibovespa',
    yaxis2=dict(title='Sentimento', overlaying='y', side='right')
)

# ----------------------------
# 4. Salvar gráfico em HTML
# ----------------------------
html_file = "sentimento_ibov_diario.html"
fig.write_html(html_file)
print(f"Arquivo HTML gerado com sucesso: {html_file}")
