<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Dashboard – Ativos de Risco x Seguros</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
body { font-family: Arial, sans-serif; margin: 0; background: #f4f6f8; }
header { background: #1f2937; color: white; padding: 15px; text-align: center; }
#controls, #date-controls { text-align: center; padding: 10px; }
button { margin: 5px; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; background: #e5e7eb; }
button.active { background: #2563eb; color: white; }
#grafico { width: 100%; height: 500px; }
input[type="datetime-local"] { margin: 0 5px; padding: 5px; }
#intervaloSelecionado { text-align: center; margin: 10px; font-weight: bold; }
</style>
</head>
<body>

<header>
<h2>Ativos de Risco x Seguros – Dashboard</h2>
</header>

<div id="controls">
<button onclick="setTimeframe(0.5, this)">30s</button>
<button onclick="setTimeframe(1, this)" class="active">1m</button>
<button onclick="setTimeframe(5, this)">5m</button>
<button onclick="setTimeframe(15, this)">15m</button>
<button onclick="setTimeframe(60, this)">1h</button>
</div>

<div id="date-controls">
<label>De: <input type="datetime-local" id="startDate"></label>
<label>Até: <input type="datetime-local" id="endDate"></label>
<button onclick="filtrarDatas()">Comparar</button>
<button onclick="removerFiltro()">Remover Filtro</button>
</div>

<div id="intervaloSelecionado"></div>
<div id="grafico"></div>

<script>
let timeframe = 1; // minutos
let timer = null;
let emTempoReal = true;

let datas = [];
let risco = [];
let seguro = [];

let valorRisco = 100;
let valorSeguro = 100;
const pontosHistorico = 120;

function atualizarValores(valor, volatilidade) {
    return Math.max(0, valor + (Math.random() - 0.5) * volatilidade);
}

function gerarHistorico(pontos) {
    let datasHist = [], riscoHist = [], seguroHist = [];
    let valR = 100, valS = 100;
    const agora = new Date();
    for (let i = pontos-1; i>=0; i--){
        const hora = new Date(agora - i*timeframe*60000);
        valR = atualizarValores(valR,2);
        valS = atualizarValores(valS,0.5);
        datasHist.push(hora);
        riscoHist.push(valR);
        seguroHist.push(valS);
    }
    return {datasHist, riscoHist, seguroHist, valR, valS};
}

function atualizarGrafico() {
    if (!emTempoReal) return;
    const agora = new Date();
    valorRisco = atualizarValores(valorRisco,2);
    valorSeguro = atualizarValores(valorSeguro,0.5);
    datas.push(agora);
    risco.push(valorRisco);
    seguro.push(valorSeguro);
    if(datas.length>pontosHistorico){ datas.shift(); risco.shift(); seguro.shift(); }
    Plotly.extendTraces('grafico',{x:[[agora],[agora]], y:[[valorRisco],[valorSeguro]]},[0,1],pontosHistorico);
}

function setTimeframe(minutos, botao) {
    timeframe = minutos;
    document.querySelectorAll('#controls button').forEach(b=>b.classList.remove('active'));
    botao.classList.add('active');
    if(timer) clearInterval(timer);
    timer=setInterval(atualizarGrafico,timeframe*60000);
}

// Filtrar período mostrando todos os pontos dentro do intervalo
function filtrarDatas() {
    const startInput = document.getElementById('startDate').value;
    const endInput = document.getElementById('endDate').value;
    if(!startInput || !endInput){ alert('Selecione datas válidas!'); return; }
    const start = new Date(startInput);
    const end = new Date(endInput);
    if(start>end){ alert('Data inicial maior que final!'); return; }

    emTempoReal=false;

    // Criar array X completo no intervalo (diário)
    const filteredX=[];
    const filteredRisco=[];
    const filteredSeguro=[];
    let current = new Date(start);
    while(current <= end){
        filteredX.push(new Date(current));
        // Procurar ponto mais próximo
        let closestIdx = null;
        let minDiff = Infinity;
        for(let i=0;i<datas.length;i++){
            let diff=Math.abs(datas[i]-current);
            if(diff<minDiff){ minDiff=diff; closestIdx=i; }
        }
        if(minDiff<=timeframe*60000){ // se houver dado próximo, usa
            filteredRisco.push(risco[closestIdx]);
            filteredSeguro.push(seguro[closestIdx]);
        } else {
            filteredRisco.push(null);
            filteredSeguro.push(null);
        }
        current.setDate(current.getDate()+1);
    }

    Plotly.update('grafico',{x:[filteredX,filteredX],y:[filteredRisco,filteredSeguro]});
    Plotly.relayout('grafico',{'xaxis.range':[start,end],'xaxis.tickformat':'%b/%Y'});

    document.getElementById('intervaloSelecionado').innerText=
        `Intervalo selecionado: ${start.toLocaleDateString()} até ${end.toLocaleDateString()}`;
}

function removerFiltro(){
    emTempoReal=true;
    document.getElementById('intervaloSelecionado').innerText='';
    Plotly.update('grafico',{x:[datas,datas],y:[risco,seguro]});
    Plotly.relayout('grafico',{'xaxis.autorange':true,'xaxis.tickformat':null});
}

/* Inicialização */
const hist = gerarHistorico(pontosHistorico);
datas=hist.datasHist; risco=hist.riscoHist; seguro=hist.seguroHist;
valorRisco=hist.valR; valorSeguro=hist.valS;

const layout = {
    title:'Comparação em Tempo Real',
    xaxis:{title:'Data',type:'date'},
    yaxis:{title:'Valor'},
    margin:{t:50}
};

Plotly.newPlot('grafico',[
    {x:datas,y:risco,mode:'lines',name:'Ativos de Risco',line:{color:'red'}},
    {x:datas,y:seguro,mode:'lines',name:'Ativos Seguros',line:{color:'green'}}
],layout,{responsive:true});

timer=setInterval(atualizarGrafico,timeframe*60000);
window.addEventListener('resize',()=>{Plotly.Plots.resize('grafico');});
</script>

</body>
</html>
