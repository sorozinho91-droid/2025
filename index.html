<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sentimento do Mercado Global</title>

<style>
body {
  font-family: Arial, sans-serif;
  background:#f4f6f8;
  margin:0;
  display:flex;
  flex-direction:column;
  align-items:center;
}

header {
  width:100%;
  background:#1f2937;
  color:#fff;
  padding:10px;
  text-align:center;
}

#relogio {
  margin:10px;
  font-weight:bold;
}

table {
  width:560px;
  background:#fff;
  border-collapse:collapse;
  box-shadow:0 2px 6px rgba(0,0,0,.15);
}

th, td {
  border:1px solid #ccc;
  padding:6px;
  text-align:center;
}

th {
  background:#2563eb;
  color:white;
}

.risco { color:green; font-weight:bold; }
.seguro { color:red; font-weight:bold; }

#sentimentoBarContainer {
  width:560px;
  height:28px;
  background:#e5e7eb;
  border-radius:6px;
  margin:20px 0;
  overflow:hidden;
}

#sentimentoBar {
  height:100%;
  width:50%;
  background:linear-gradient(to right, red, green);
  color:white;
  font-weight:bold;
  text-align:center;
  line-height:28px;
  transition:width .6s;
}
</style>
</head>

<body>

<header>
  <h2>Sentimento do Mercado Global</h2>
</header>

<div id="relogio"></div>

<table id="tabela">
<thead>
<tr>
  <th>Ativo</th>
  <th>Classe</th>
  <th>Variação (%)</th>
</tr>
</thead>
<tbody>
<tr><td colspan="3">Carregando dados...</td></tr>
</tbody>
</table>

<div id="sentimentoBarContainer">
  <div id="sentimentoBar">50% Neutro</div>
</div>

<script>
/* ================== RELÓGIO BR ================== */
function relogioBR(){
  const d = new Date();
  const utc = d.getTime() + d.getTimezoneOffset()*60000;
  const br = new Date(utc - 3*3600000);
  document.getElementById("relogio").textContent =
    "Horário de Brasília: " + br.toLocaleTimeString();
}
setInterval(relogioBR,1000);
relogioBR();

/* ================== CONFIG ================== */
const API_KEY = "d58a789r01qptoar8c7gd58a789r01qptoar8c80";

/*
CLASSES:
- RISCO: ações
- SEGURANÇA: dólar, ouro
Símbolos escolhidos porque EXISTEM no Alpha Vantage
*/
const ativos = [
  { nome:"S&P 500", classe:"risco", symbol:"SPY" },
  { nome:"Nasdaq", classe:"risco", symbol:"QQQ" },
  { nome:"Dow Jones", classe:"risco", symbol:"DIA" },
  { nome:"Dólar (UUP)", classe:"seguro", symbol:"UUP" },
  { nome:"Ouro", classe:"seguro", commodity:true }
];

let indice = 0;
let ultimos = {};

/* ================== FETCH ================== */
async function buscarAtivo(ativo){
  if(ativo.commodity){
    const url = `https://www.alphavantage.co/query?function=COMMODITY_EXCHANGE_RATE&from_symbol=XAU&to_symbol=USD&apikey=${API_KEY}`;
    const r = await fetch(url);
    const j = await r.json();
    return Number(j["Realtime Commodity Exchange Rate"]?.["5. Exchange Rate"]);
  } else {
    const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${ativo.symbol}&apikey=${API_KEY}`;
    const r = await fetch(url);
    const j = await r.json();
    return Number(j["Global Quote"]?.["10. change percent"]?.replace("%",""));
  }
}

/* ================== ATUALIZA ================== */
async function atualizar(){
  const tbody = document.querySelector("#tabela tbody");
  tbody.innerHTML = "";

  let scoreRisco = 0;
  let scoreSeguro = 0;

  for(const ativo of ativos){
    let variacao = 0;

    try{
      if(ativo.commodity){
        const preco = await buscarAtivo(ativo);
        const prev = ultimos[ativo.nome] ?? preco;
        variacao = ((preco - prev) / prev * 100);
        ultimos[ativo.nome] = preco;
      } else {
        variacao = await buscarAtivo(ativo);
      }
    }catch(e){ variacao = 0; }

    if(ativo.classe === "risco") scoreRisco += variacao;
    else scoreSeguro += variacao;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${ativo.nome}</td>
      <td class="${ativo.classe}">${ativo.classe.toUpperCase()}</td>
      <td>${variacao.toFixed(2)}%</td>
    `;
    tbody.appendChild(tr);
  }

  /* ===== SENTIMENTO ===== */
  const total = Math.abs(scoreRisco) + Math.abs(scoreSeguro) || 1;
  const riscoPct = Math.round((scoreRisco + total) / (2*total) * 100);

  const bar = document.getElementById("sentimentoBar");
  bar.style.width = riscoPct + "%";
  bar.textContent =
    riscoPct > 55 ? `${riscoPct}% Apetite ao Risco` :
    riscoPct < 45 ? `${riscoPct}% Busca por Segurança` :
    `${riscoPct}% Neutro`;
}

/*
Alpha Vantage free:
5 req / minuto
→ 1 ciclo completo a cada 70s é seguro
*/
atualizar();
setInterval(atualizar, 70000);
</script>

</body>
</html>
