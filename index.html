<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Comparação de Ativos - Risco x Segurança</title>

<script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>

<style>
body{
  background:#0e0e0e;
  color:#e0e0e0;
  font-family:Arial, Helvetica, sans-serif;
  margin:20px;
}
#grafico{
  width:100%;
  height:520px;
  background:#111;
  border-radius:8px;
}
#sinal{
  font-size:22px;
  font-weight:bold;
  margin-top:10px;
}
.compra{color:#00c853}
.venda{color:#d50000}
.neutro{color:#ffeb3b}
</style>
</head>

<body>

<h2>Comparação de Ativos - Risco x Segurança</h2>
<p>Dados em tempo real • Atualização 30s</p>

<div id="grafico"></div>
<div id="sinal" class="neutro">SINAL: AGUARDANDO DADOS…</div>

<script>
const chart = echarts.init(document.getElementById("grafico"));

let eixoX = [];
let ativos = ["USD-BRL", "BTC-BRL", "Ouro"]; // ativos para comparação
let ultimoValores = {}; // armazena últimos valores
let seriesData = {}; // armazena série de cada ativo

// inicializa séries
ativos.forEach(a => seriesData[a] = {risco:[], seguranca:[]});

async function pegarValorAtivo(ativo){
  try{
    if(ativo === "USD-BRL"){
      const res = await fetch('https://economia.awesomeapi.com.br/json/last/USD-BRL');
      const data = await res.json();
      return parseFloat(data.USDBRL.bid);
    }else if(ativo === "BTC-BRL"){
      const res = await fetch('https://economia.awesomeapi.com.br/json/last/BTC-BRL');
      const data = await res.json();
      return parseFloat(data.BTCBRL.bid);
    }else if(ativo === "Ouro"){
      // API simulada: Ouro em BRL/grama
      const res = await fetch('https://www.quandl.com/api/v3/datasets/LBMA/GOLD.json?rows=1&api_key=demo'); 
      const data = await res.json();
      return parseFloat(data.dataset.data[0][1]); // preço do ouro
    }
  }catch(err){
    console.error("Erro ao buscar ativo", ativo, err);
    return null;
  }
}

function calcularIndicadores(valorAtual, ativo){
  let r=0, s=0;
  if(ultimoValores[ativo] !== undefined){
    const delta = valorAtual - ultimoValores[ativo];
    const percentual = delta / ultimoValores[ativo];
    r = percentual;
    s = -percentual;
  }
  ultimoValores[ativo] = valorAtual;
  return [r, s];
}

async function atualizarGrafico(){
  const hora = new Date().toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit",second:"2-digit"});
  eixoX.push(hora);
  if(eixoX.length > 120) eixoX.shift();

  let sinalTexto = "";
  let sinalClass = "neutro";

  // para cada ativo, buscar valor e atualizar séries
  for(let ativo of ativos){
    const valor = await pegarValorAtivo(ativo);
    if(valor === null) continue;

    const [r, s] = calcularIndicadores(valor, ativo);

    seriesData[ativo].risco.push(+r.toFixed(4));
    seriesData[ativo].seguranca.push(+s.toFixed(4));

    if(seriesData[ativo].risco.length > 120){
      seriesData[ativo].risco.shift();
      seriesData[ativo].seguranca.shift();
    }

    // sinal baseado no último ativo como exemplo
    if(s - r > 0.0025){ sinalTexto="COMPRA"; sinalClass="compra"; }
    else if(s - r < -0.0025){ sinalTexto="VENDA"; sinalClass="venda"; }
    else{ sinalTexto="NEUTRO"; sinalClass="neutro"; }
  }

  document.getElementById("sinal").textContent = "SINAL: "+sinalTexto;
  document.getElementById("sinal").className = sinalClass;

  // montar séries para o gráfico
  const series = [];
  for(let ativo of ativos){
    series.push({
      name: ativo+" Risco",
      type:"line",
      smooth:true,
      showSymbol:false,
      data:seriesData[ativo].risco,
      lineStyle:{width:2}
    });
    series.push({
      name: ativo+" Segurança",
      type:"line",
      smooth:true,
      showSymbol:false,
      data:seriesData[ativo].seguranca,
      lineStyle:{width:2,type:"dashed"}
    });
  }

  chart.setOption({
    backgroundColor:"#111",
    tooltip:{trigger:"axis"},
    legend:{data:series.map(s=>s.name),textStyle:{color:"#ccc"}},
    xAxis:{type:"category", data:eixoX, axisLabel:{color:"#aaa"}},
    yAxis:{
      scale:true,
      axisLabel:{
        formatter: v => (v*100).toFixed(2)+"%",
        color:"#aaa"
      },
      splitLine:{lineStyle:{color:"#222"}}
    },
    series:series
  });
}

// Atualizar a cada 30 segundos
atualizarGrafico();
setInterval(atualizarGrafico, 30000);
</script>

</body>
</html>
