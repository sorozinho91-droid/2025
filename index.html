<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Dashboard – Ativos de Risco x Seguros (5 Anos)</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
body { font-family: Arial, sans-serif; margin: 0; background: #f4f6f8; }
header { background: #1f2937; color: white; padding: 15px; text-align: center; }
#controls, #date-controls { text-align: center; padding: 10px; }
button { margin: 5px; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; background: #e5e7eb; }
button.active { background: #2563eb; color: white; }
#grafico { width: 100%; height: 600px; }
input[type="datetime-local"] { margin: 0 5px; padding: 5px; }
#intervaloSelecionado { text-align: center; margin: 10px; font-weight: bold; }
</style>
</head>
<body>

<header>
<h2>Ativos de Risco x Seguros – Dashboard (5 Anos)</h2>
</header>

<div id="controls">
<button onclick="setTimeframe(0.5, this)">30s</button>
<button onclick="setTimeframe(1, this)" class="active">1m</button>
<button onclick="setTimeframe(5, this)">5m</button>
<button onclick="setTimeframe(15, this)">15m</button>
<button onclick="setTimeframe(60, this)">1h</button>
</div>

<div id="date-controls">
<label>De: <input type="datetime-local" id="startDate"></label>
<label>Até: <input type="datetime-local" id="endDate"></label>
<button onclick="filtrarDatas()">Comparar</button>
<button onclick="removerFiltro()">Remover Filtro</button>
</div>

<div id="intervaloSelecionado"></div>
<div id="grafico"></div>

<script>
let timeframe = 1; // minutos
let timer = null;
let emTempoReal = true;

// Histórico real
let datas = [], risco = [], seguro = [];
let valorRisco = 100, valorSeguro = 100;

// Função para gerar valores aleatórios
function atualizarValores(valor, vol){
    return Math.max(0, valor + (Math.random()-0.5)*vol);
}

// Gera histórico real de até 5 anos (1 ponto por dia)
function gerarHistoricoAnual(anos=5){
    const dataHoje = new Date();
    const start = new Date(dataHoje.getFullYear()-anos, dataHoje.getMonth(), dataHoje.getDate());
    let valR = 100, valS = 100;
    datas = []; risco = []; seguro = [];
    for(let d = new Date(start); d <= dataHoje; d.setDate(d.getDate()+1)){
        valR = atualizarValores(valR,2);
        valS = atualizarValores(valS,0.5);
        datas.push(new Date(d));
        risco.push(valR);
        seguro.push(valS);
    }
    valorRisco = valR; valorSeguro = valS;
}

// Atualização em tempo real
function atualizarGrafico(){
    if(!emTempoReal) return;
    const agora = new Date();
    valorRisco = atualizarValores(valorRisco,2);
    valorSeguro = atualizarValores(valorSeguro,0.5);
    datas.push(agora);
    risco.push(valorRisco);
    seguro.push(valorSeguro);
    Plotly.extendTraces('grafico',{x:[[agora],[agora]], y:[[valorRisco],[valorSeguro]]}, [0,1]);
}

// Muda timeframe
function setTimeframe(minutos, botao){
    timeframe = minutos;
    document.querySelectorAll('#controls button').forEach(b=>b.classList.remove('active'));
    botao.classList.add('active');
    if(timer) clearInterval(timer);
    timer=setInterval(atualizarGrafico, timeframe*60000);
}

// Filtrar período com histórico real
function filtrarDatas(){
    const startInput = document.getElementById('startDate').value;
    const endInput = document.getElementById('endDate').value;
    if(!startInput || !endInput){ alert('Selecione datas válidas'); return; }
    const start = new Date(startInput);
    const end = new Date(endInput);
    if(start>end){ alert('Data inicial maior que final'); return; }

    emTempoReal = false;

    const filteredX = [], filteredR = [], filteredS = [];
    for(let i=0;i<datas.length;i++){
        if(datas[i]>=start && datas[i]<=end){
            filteredX.push(datas[i]);
            filteredR.push(risco[i]);
            filteredS.push(seguro[i]);
        }
    }

    Plotly.update('grafico',{x:[filteredX,filteredX], y:[filteredR,filteredS]});
    Plotly.relayout('grafico',{
        'xaxis.range':[start,end],
        'xaxis.tickformat':'%b/%Y'
    });

    document.getElementById('intervaloSelecionado').innerText =
        `Intervalo selecionado: ${start.toLocaleDateString()} até ${end.toLocaleDateString()}`;
}

// Remover filtro e voltar para tempo real
function removerFiltro(){
    emTempoReal = true;
    document.getElementById('intervaloSelecionado').innerText='';
    Plotly.update('grafico',{x:[datas,datas], y:[risco,seguro]});
    Plotly.relayout('grafico',{'xaxis.autorange':true,'xaxis.tickformat':null});
}

/* Inicialização */
gerarHistoricoAnual(5);

const layout = {
    title:'Comparação em Tempo Real',
    xaxis:{title:'Data', type:'date'},
    yaxis:{title:'Valor'},
    margin:{t:50}
};

Plotly.newPlot('grafico',[
    {x:datas, y:risco, mode:'lines', name:'Ativos de Risco', line:{color:'red'}},
    {x:datas, y:seguro, mode:'lines', name:'Ativos Seguros', line:{color:'green'}}
], layout, {responsive:true});

timer = setInterval(atualizarGrafico, timeframe*60000);
window.addEventListener('resize',()=>{Plotly.Plots.resize('grafico');});
</script>

</body>
</html>
