<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF‚Äë8">
<title>Sentimento e Tend√™ncia do Mercado Global</title>

<style>
body { font-family: Arial, sans-serif; margin:0; background:#f4f6f8; display:flex; flex-direction:column; align-items:center; }
header { background:#1f2937; color:white; padding:10px; text-align:center; width:100%; }
#relogio { margin:10px 0; font-size:16px; font-weight:bold; }

/* Tabela */
#tabelaSentimento {
    width:700px; font-size:14px;
    background:#fff; border-collapse:collapse;
    box-shadow:0 2px 6px rgba(0,0,0,0.1);
    margin-top:20px;
}
#tabelaSentimento th, #tabelaSentimento td {
    padding:8px; border:1px solid #ccc; text-align:center;
}
#tabelaSentimento thead th { background:#2563eb; color:white; }
td.variacao { font-weight:bold; color:white; border-radius:4px; }

/* Tooltip */
td[title]{ position:relative; cursor:pointer; }
td[title]:hover::after{
  content:attr(title);
  position:absolute; bottom:110%; left:50%; transform:translateX(-50%);
  background:#111827; color:#fff; padding:6px 10px; border-radius:4px;
  white-space:nowrap; font-size:12px; z-index:20;
}

/* Sentiment Bar */
#sentimentoBarContainer {
    width:700px; height:36px; background:#e5e7eb;
    border-radius:6px; margin:20px 0; overflow:hidden;
}
#sentimentoBar {
    height:100%; width:50%; text-align:center;
    line-height:36px; color:white; font-weight:bold;
    transition: width 0.6s, background 0.6s;
}
#sentimentoBar.risco { background:green; }
#sentimentoBar.seguro { background:red; }
#sentimentoBar.pisca { animation: blink 1s infinite; }
@keyframes blink { 0%,100%{opacity:1;}50%{opacity:0.5;} }

/* News Panel */
#painel-news {
  position:fixed; top:28px; right:10px; width:360px;
  background:#111827; color:white; border-radius:6px;
  box-shadow:0 4px 8px rgba(0,0,0,0.3); z-index:9998;
}
.news-header{ text-align:center; font-weight:bold; padding:8px; background:#1f2937; }
#newsList{ max-height:260px; overflow-y:auto; font-size:13px; }
.news-item{ padding:8px; border-bottom:1px solid #374151; }
.news-item a{ color:#93c5fd; text-decoration:none; }

/* Market Alert */
#alerta-mercado {
  position:fixed; top:32px; left:10px; width:300px;
  background:#fff; border-left:5px solid #c00000;
  box-shadow:0 2px 8px rgba(0,0,0,0.2); font-size:12px; z-index:9999;
}
.alerta-header { background:#c00000; color:#fff; text-align:center; padding:6px; font-weight:bold; font-size:13px; }
#alerta-conteudo{ padding:8px; font-size:12px; }
</style>
</head>
<body>

<header>
<h2>üìä Sentimento e Tend√™ncia do Mercado Global</h2>
</header>

<div id="relogio"></div>

<table id="tabelaSentimento">
<thead><tr><th>Ativo</th><th>Tipo</th><th>Varia√ß√£o (%)</th></tr></thead>
<tbody><tr><td colspan="3">Carregando dados reais...</td></tr></tbody>
</table>

<div id="sentimentoBarContainer">
    <div id="sentimentoBar">Carregando...</div>
</div>

<!-- Breaking News -->
<div id="painel-news">
  <div class="news-header">üö® BREAKING NEWS ‚Äì Macro</div>
  <div id="newsList"><div class="news-item">Aguardando not√≠cias...</div></div>
</div>

<!-- Market Alert -->
<div id="alerta-mercado">
  <div class="alerta-header">‚ö†Ô∏è ALERTA MERCADO</div>
  <div id="alerta-conteudo">Aguardando not√≠cias...</div>
</div>

<audio id="alertSound" src="https://assets.mixkit.co/sfx/preview/mixkit-alert-alarm-1005.mp3"></audio>
<audio id="alerta-som" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<script>
// ===== Hor√°rio de Bras√≠lia =====
function agoraBrasilia(){
    const agora = new Date();
    const offset = -3;
    const utc = agora.getTime() + agora.getTimezoneOffset()*60000;
    return new Date(utc + offset*3600000);
}
function atualizarRelogio(){
    const d = agoraBrasilia();
    document.getElementById("relogio").textContent =
      `üïí Hor√°rio de Bras√≠lia: ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
}
setInterval(atualizarRelogio,1000);
atualizarRelogio();

// ===== Ativos de Risco e Seguran√ßa =====
const ativosRisco = [
  {nome:"S&P 500", sym:"INDEX:SPX"},
  {nome:"Nasdaq", sym:"INDEX:NDX"},
  {nome:"Dow Jones", sym:"INDEX:DJI"},
  {nome:"DAX", sym:"INDEX:DAX"},
  {nome:"FTSE 100", sym:"INDEX:UKX"},
  {nome:"Hang Seng", sym:"INDEX:HSI"}
];
const ativosSeguro = [
  {nome:"DXY - D√≥lar", sym:"FOREXCOM:DX1!"},
  {nome:"VIX - Volatilidade", sym:"CBOE:VIX"},
  {nome:"Ouro", sym:"COMEX:GC1!"}
];

// Guarda pre√ßos anteriores
let prevPrices = {};

// Busca pre√ßo real da TradingView p√∫blica
async function fetchPriceTV(symbol){
    const url = "https://api.allorigins.win/raw?url=" +
                encodeURIComponent(`https://s3.tradingview.com/symbols/${symbol.replace(/[:!]/g,"_")}.json`);
    try {
        const resp = await fetch(url);
        const json = await resp.json();
        // last_price √© o pre√ßo atual, close pode ser fallback
        return json.last_price ?? json.close ?? 0;
    } catch(e) {
        console.error("TV fetch erro:", symbol, e);
        return 0;
    }
}

// Converte varia√ß√£o em cor gradiente (vermelho‚Üíverde)
function gradienteCor(val){
    let v = Math.max(-5, Math.min(5, val));
    // mapeia -5‚Üí0 vermelho, +5‚Üí100 verde
    const pct = ((v + 5) / 10) * 100;
    return `linear-gradient(to right, red ${100-pct}%, green ${pct}%)`;
}

// Atualiza tabela e sentimento
async function atualizarSentimento(){
    const tbody = document.querySelector("#tabelaSentimento tbody");
    tbody.innerHTML = "";
    let somaR=0, somaS=0;

    // Risco
    for(const a of ativosRisco){
        const price = await fetchPriceTV(a.sym);
        const prev = prevPrices[a.sym] ?? price;
        const vari = ((price - prev) / (prev||1) * 100).toFixed(2);
        prevPrices[a.sym] = price;
        somaR += parseFloat(vari);

        const tr = document.createElement("tr");
        tr.innerHTML =
          `<td title="Pre√ßo: ${price.toFixed(2)}\nA√ß√£o: Compra de Bolsa">${a.nome}</td>
           <td class="risco">Risco</td>
           <td class="variacao" style="background:${gradienteCor(vari)}">${vari}%</td>`;
        tbody.appendChild(tr);
    }

    // Seguran√ßa
    for(const a of ativosSeguro){
        const price = await fetchPriceTV(a.sym);
        const prev = prevPrices[a.sym] ?? price;
        const vari = ((price - prev) / (prev||1) * 100).toFixed(2);
        prevPrices[a.sym] = price;
        somaS += parseFloat(vari);

        const tr = document.createElement("tr");
        tr.innerHTML =
          `<td title="Pre√ßo: ${price.toFixed(2)}\nA√ß√£o: Compra de D√≥lar/Ouro">${a.nome}</td>
           <td class="seguro">Seguran√ßa</td>
           <td class="variacao" style="background:${gradienteCor(vari)}">${vari}%</td>`;
        tbody.appendChild(tr);
    }

    // Atualiza barra de sentimento
    const bar = document.getElementById("sentimentoBar");
    const mediaR = (somaR/ativosRisco.length).toFixed(2);
    const mediaS = (somaS/ativosSeguro.length).toFixed(2);
    const trendPct = Math.round(100 * (mediaR / (Math.abs(mediaR)+Math.abs(mediaS)||1)));

    if(mediaR > mediaS){
        bar.textContent = `üìà Mercado em Tend√™ncia de Alta ‚Üí compra de Bolsa (${trendPct}%)`;
        bar.className = "risco";
    } else {
        bar.textContent = `üìâ Mercado em Tend√™ncia de Baixa ‚Üí venda de Bolsa / compra de D√≥lar (${100-trendPct}%)`;
        bar.className = "seguro";
    }
}

// Primeiro carregamento + loop
atualizarSentimento();
setInterval(atualizarSentimento, 60000);

// ===== BREAKING NEWS (Google News) =====
const palavras = ["fed","cpi","juros","taxa","guerra","inflacao","taxas"];
const newsList = document.getElementById("newsList");
let cacheNews = {};
async function buscarNoticias(){
  const rss = "https://news.google.com/rss/search?q=" + encodeURIComponent(palavras.join(" OR ")) + "&hl=pt-BR&gl=BR&ceid=BR:pt";
  const proxy = "https://api.allorigins.win/raw?url=" + encodeURIComponent(rss);
  try{
    const res = await fetch(proxy);
    const xml = new DOMParser().parseFromString(await res.text(),"text/xml");
    xml.querySelectorAll("item").forEach(item => {
      const title = item.querySelector("title")?.textContent;
      const link  = item.querySelector("link")?.textContent;
      if(title && !cacheNews[link]){
        cacheNews[link] = true;
        const div = document.createElement("div");
        div.className="news-item";
        div.innerHTML = `üö® <strong>${title}</strong><br><a href="${link}" target="_blank">Ler not√≠cia</a>`;
        newsList.prepend(div);
      }
    });
  }catch(e){ console.error("Erro news",e); }
}
buscarNoticias();
setInterval(buscarNoticias,30000);

// ===== ALERTA MERCADO =====
const alertaConteudo = document.getElementById("alerta-conteudo");
let ultimaAlerta="";
async function buscarAlerta(){
  const rss = "https://news.google.com/rss/search?q=mercado+financeiro+OR+taxas+juros&hl=pt-BR&gl=BR&ceid=BR:pt";
  const proxy = "https://api.allorigins.win/raw?url=" + encodeURIComponent(rss);
  try{
    const res = await fetch(proxy);
    const xml = new DOMParser().parseFromString(await res.text(),"text/xml");
    const item = xml.querySelector("item");
    if(item){
      const title = item.querySelector("title").textContent;
      const link  = item.querySelector("link").textContent;
      if(title !== ultimaAlerta){
        ultimaAlerta = title;
        alertaConteudo.innerHTML = `üì∞ <a href="${link}" target="_blank">${title}</a>`;
      }
    }
  }catch(e){ console.error("Erro alerta",e); }
}
buscarAlerta();
setInterval(buscarAlerta,60000);

</script>
</body>
</html>
