<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Dashboard – Ativos de Risco x Seguros</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
body { font-family: Arial, sans-serif; margin: 0; background: #f4f6f8; }
header { background: #1f2937; color: white; padding: 15px; text-align: center; }
#controls, #date-controls { text-align: center; padding: 10px; }
button { margin: 5px; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; background: #e5e7eb; }
button.active { background: #2563eb; color: white; }
#grafico { width: 100%; height: 500px; }
input[type="datetime-local"] { margin: 0 5px; padding: 5px; }
#intervaloSelecionado { text-align: center; margin: 10px; font-weight: bold; }
</style>
</head>
<body>

<header>
<h2>Ativos de Risco x Seguros – Dashboard</h2>
</header>

<div id="controls">
<button onclick="setTimeframe(0.5, this)">30s</button>
<button onclick="setTimeframe(1, this)" class="active">1m</button>
<button onclick="setTimeframe(5, this)">5m</button>
<button onclick="setTimeframe(15, this)">15m</button>
<button onclick="setTimeframe(60, this)">1h</button>
</div>

<div id="date-controls">
<label>De: <input type="datetime-local" id="startDate"></label>
<label>Até: <input type="datetime-local" id="endDate"></label>
<button onclick="filtrarDatas()">Comparar</button>
<button onclick="removerFiltro()">Remover Filtro</button>
</div>

<div id="intervaloSelecionado"></div>
<div id="grafico"></div>

<script>
let timeframe = 1;
let timer = null;
let emTempoReal = true;

let datas = [], risco = [], seguro = [];
let valorRisco = 100, valorSeguro = 100;
const pontosHistorico = 200;

// Função para gerar valores aleatórios
function atualizarValores(valor, vol){
    return Math.max(0, valor + (Math.random()-0.5)*vol);
}

// Gera histórico inicial
function gerarHistorico(pontos){
    let datasH=[], riscoH=[], seguroH=[];
    let valR=100, valS=100;
    const agora=new Date();
    for(let i=pontos-1;i>=0;i--){
        const hora=new Date(agora - i*timeframe*60000);
        valR = atualizarValores(valR,2);
        valS = atualizarValores(valS,0.5);
        datasH.push(hora);
        riscoH.push(valR);
        seguroH.push(valS);
    }
    return {datasH, riscoH, seguroH, valR, valS};
}

// Atualização em tempo real
function atualizarGrafico(){
    if(!emTempoReal) return;
    const agora = new Date();
    valorRisco = atualizarValores(valorRisco,2);
    valorSeguro = atualizarValores(valorSeguro,0.5);
    datas.push(agora);
    risco.push(valorRisco);
    seguro.push(valorSeguro);
    if(datas.length>pontosHistorico){ datas.shift(); risco.shift(); seguro.shift(); }
    Plotly.extendTraces('grafico',{x:[[agora],[agora]],y:[[valorRisco],[valorSeguro]]},[0,1],pontosHistorico);
}

// Muda timeframe
function setTimeframe(minutos, botao){
    timeframe = minutos;
    document.querySelectorAll('#controls button').forEach(b=>b.classList.remove('active'));
    botao.classList.add('active');
    if(timer) clearInterval(timer);
    timer=setInterval(atualizarGrafico,timeframe*60000);
}

// Filtrar período com interpolação mês a mês
function filtrarDatas(){
    const startInput=document.getElementById('startDate').value;
    const endInput=document.getElementById('endDate').value;
    if(!startInput || !endInput){ alert('Selecione datas válidas'); return; }
    const start=new Date(startInput);
    const end=new Date(endInput);
    if(start>end){ alert('Data inicial maior que final'); return; }

    emTempoReal = false;

    const filteredX=[], filteredR=[], filteredS=[];
    let current = new Date(start.getFullYear(), start.getMonth(), 1);
    const endMonth = new Date(end.getFullYear(), end.getMonth(), 1);

    let lastR=risco[0]||valorRisco;
    let lastS=seguro[0]||valorSeguro;

    while(current <= endMonth){
        filteredX.push(new Date(current));
        // Busca o ponto mais próximo no mês
        let closestIdx = null;
        let minDiff = Infinity;
        for(let i=0;i<datas.length;i++){
            if(datas[i].getFullYear()===current.getFullYear() && datas[i].getMonth()===current.getMonth()){
                let diff=Math.abs(datas[i]-current);
                if(diff<minDiff){ minDiff=diff; closestIdx=i; }
            }
        }
        if(closestIdx!==null){
            lastR = risco[closestIdx];
            lastS = seguro[closestIdx];
        }
        // Usa o último valor conhecido (interpolação)
        filteredR.push(lastR);
        filteredS.push(lastS);
        current.setMonth(current.getMonth()+1);
    }

    Plotly.update('grafico',{x:[filteredX,filteredX], y:[filteredR,filteredS]});
    Plotly.relayout('grafico',{
        'xaxis.range':[start,end],
        'xaxis.tickformat':'%b/%Y'
    });

    document.getElementById('intervaloSelecionado').innerText=
        `Intervalo selecionado: ${start.toLocaleDateString()} até ${end.toLocaleDateString()}`;
}

// Remover filtro
function removerFiltro(){
    emTempoReal = true;
    document.getElementById('intervaloSelecionado').innerText='';
    Plotly.update('grafico',{x:[datas,datas], y:[risco,seguro]});
    Plotly.relayout('grafico',{'xaxis.autorange':true,'xaxis.tickformat':null});
}

/* Inicialização */
const hist = gerarHistorico(pontosHistorico);
datas=hist.datasH; risco=hist.riscoH; seguro=hist.seguroH;
valorRisco=hist.valR; valorSeguro=hist.valS;

const layout = {
    title:'Comparação em Tempo Real',
    xaxis:{title:'Data', type:'date'},
    yaxis:{title:'Valor'},
    margin:{t:50}
};

Plotly.newPlot('grafico',[
    {x:datas,y:risco,mode:'lines',name:'Ativos de Risco', line:{color:'red'}},
    {x:datas,y:seguro,mode:'lines',name:'Ativos Seguros', line:{color:'green'}}
], layout, {responsive:true});

timer = setInterval(atualizarGrafico, timeframe*60000);
window.addEventListener('resize',()=>{Plotly.Plots.resize('grafico');});
</script>

</body>
</html>
