<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Direção Intraday do Dólar</title>

<script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>

<style>
body{
  background:#0e0e0e;
  color:#e0e0e0;
  font-family:Arial, Helvetica, sans-serif;
  margin:20px;
}
#grafico{
  width:100%;
  height:520px;
  background:#111;
  border-radius:8px;
}
#sinal{
  font-size:22px;
  font-weight:bold;
  margin-top:10px;
}
.compra{color:#00c853}
.venda{color:#d50000}
.neutro{color:#ffeb3b}
</style>
</head>

<body>

<h2>Direção Intraday do Dólar</h2>
<p>Risco × Segurança • Atualização automática a cada 60s</p>

<div id="grafico"></div>
<div id="sinal" class="neutro">SINAL: AGUARDANDO DADOS…</div>

<script>
/* =========================
   API
========================= */
const API_KEY = "d58a789r01qptoar8c7gd58a789r01qptoar8c80";
const INTERVALO = "1min";

/* =========================
   ATIVOS
========================= */
const ativosRisco = [
  "XAU/USD","HG","CL","EWZ","VALE","PBR",
  "XLF","XLP","XLE","XME","EEM","SOXX"
];

const ativosSeguranca = [
  "DXY","USD/NOK","USD/AUD","USD/NZD",
  "USD/KRW","USD/CNY","EUR/BRL"
];

/* =========================
   DIREÇÃO (OTIMIZADA)
========================= */
async function direcao(symbol){
  const url = `https://api.twelvedata.com/time_series?symbol=${symbol}&interval=${INTERVALO}&outputsize=2&apikey=${API_KEY}`;
  try{
    const r = await fetch(url);
    const d = await r.json();
    if(!d.values || d.values.length < 2) return null;

    const a = parseFloat(d.values[0].close);
    const b = parseFloat(d.values[1].close);

    return a > b ? 1 : a < b ? -1 : 0;
  }catch{
    return null;
  }
}

/* =========================
   SCORE MÉDIO
========================= */
async function score(lista){
  let soma = 0, total = 0;
  for(const a of lista){
    const d = await direcao(a);
    if(d !== null){
      soma += d;
      total++;
    }
  }
  return total ? soma / total : null;
}

/* =========================
   GRÁFICO
========================= */
const chart = echarts.init(document.getElementById("grafico"));

let eixoX = [];
let serieRisco = [];
let serieSeg = [];
let serieDiff = [];

async function atualizar(){
  const hora = new Date().toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});

  const r = await score(ativosRisco);
  const s = await score(ativosSeguranca);
  if(r === null || s === null) return;

  const d = +(s - r).toFixed(2);

  eixoX.push(hora);
  serieRisco.push(+r.toFixed(2));
  serieSeg.push(+s.toFixed(2));
  serieDiff.push(d);

  if(eixoX.length > 120){
    eixoX.shift();
    serieRisco.shift();
    serieSeg.shift();
    serieDiff.shift();
  }

  /* ===== SINAL ===== */
  const sinal = document.getElementById("sinal");
  if(d > 0.25){
    sinal.textContent = "SINAL: COMPRA DÓLAR";
    sinal.className = "compra";
  }else if(d < -0.25){
    sinal.textContent = "SINAL: VENDA DÓLAR";
    sinal.className = "venda";
  }else{
    sinal.textContent = "SINAL: NEUTRO";
    sinal.className = "neutro";
  }

  chart.setOption({
    backgroundColor:"#111",
    tooltip:{trigger:"axis"},
    legend:{
      data:["Risco","Segurança","Diferença"],
      textStyle:{color:"#ccc"}
    },
    xAxis:{
      type:"category",
      data:eixoX,
      axisLabel:{color:"#aaa"}
    },
    yAxis:{
      type:"value",
      scale:true,
      axisLabel:{color:"#aaa"},
      splitLine:{lineStyle:{color:"#222"}}
    },
    series:[
      {
        name:"Risco",
        type:"line",
        smooth:true,
        showSymbol:false,
        data:serieRisco,
        lineStyle:{color:"#00c853",width:2}
      },
      {
        name:"Segurança",
        type:"line",
        smooth:true,
        showSymbol:false,
        data:serieSeg,
        lineStyle:{color:"#d50000",width:2}
      },
      {
        name:"Diferença",
        type:"line",
        smooth:true,
        showSymbol:false,
        data:serieDiff,
        lineStyle:{color:"#ffeb3b",width:3}
      }
    ]
  });
}

/* =========================
   LOOP 60s
========================= */
atualizar();
setInterval(atualizar, 60000);
</script>

</body>
</html>
