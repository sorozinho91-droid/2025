import yfinance as yf
import pandas as pd
import requests
from textblob import TextBlob
import plotly.graph_objects as go
from datetime import datetime, timedelta

# ----------------------------
# 1. Baixar dados históricos do Ibovespa (último mês)
# ----------------------------
ibov = yf.download("^BVSP", period="1mo", interval="1d")

# ----------------------------
# 2. Pegar notícias reais (GNews API gratuita)
# ----------------------------
# Substitua 'SUA_CHAVE_API' pela sua chave do GNews
API_KEY = 'SUA_CHAVE_API'
hoje = datetime.today().strftime('%Y-%m-%d')
ontem = (datetime.today() - timedelta(days=7)).strftime('%Y-%m-%d')  # Últimos 7 dias

url = f"https://gnews.io/api/v4/search?q=Ibovespa&lang=pt&from={ontem}&to={hoje}&max=10&token={API_KEY}"
res = requests.get(url).json()

noticias = [item['title'] for item in res.get('articles', [])]

if len(noticias) == 0:
    noticias = ["Ibovespa está estável hoje"]  # fallback

# ----------------------------
# 3. Calcular sentimento diário
# ----------------------------
sentimentos = [TextBlob(n).sentiment.polarity for n in noticias]
media_sentimento = sum(sentimentos) / len(sentimentos)
ibov['Sentimento'] = [media_sentimento]*len(ibov)

# ----------------------------
# 4. Criar gráfico interativo com Plotly
# ----------------------------
fig = go.Figure()

# Linha do Ibovespa
fig.add_trace(go.Scatter(
    x=ibov.index, y=ibov['Close'],
    mode='lines', name='Ibovespa', line=dict(color='blue')
))

# Linha do Sentimento (normalizada para escala do preço)
fig.add_trace(go.Scatter(
    x=ibov.index, y=ibov['Sentimento']*ibov['Close'].max(),
    mode='lines', name='Sentimento', line=dict(color='red', dash='dash')
))

fig.update_layout(
    title='Índice de Sentimento vs Ibovespa',
    xaxis_title='Data',
    yaxis_title='Preço Ibovespa',
    yaxis2=dict(title='Sentimento', overlaying='y', side='right')
)

# ----------------------------
# 5. Salvar gráfico em HTML
# ----------------------------
fig.write_html("sentimento_ibov_avancado.html")
print("Arquivo HTML avançado gerado com sucesso: sentimento_ibov_avancado.html")
