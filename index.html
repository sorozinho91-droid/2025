<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Dashboard Risco x Seguran√ßa ‚Äì Tempo Real</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
body { font-family: Arial, sans-serif; margin:0; background:#f4f6f8; }
header { background:#1f2937; color:white; padding:15px; text-align:center; }
#grafico { width:90%; max-width:1200px; height:400px; margin:20px auto; background:#fff; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1);}
#painel-news{
  position:fixed; top:28px; right:10px; width:360px;
  background:#111827; color:white; border-radius:6px;
  box-shadow:0 4px 8px rgba(0,0,0,0.3); z-index:9998;
}
.news-header{ text-align:center; font-weight:bold; padding:8px; background:#1f2937; border-radius:6px 6px 0 0; }
#newsList{ max-height:260px; overflow-y:auto; font-size:13px; }
.news-item{ padding:8px; border-bottom:1px solid #374151; }
.news-item a{ color:#93c5fd; text-decoration:none; }
.breaking{ animation:piscar 1s infinite; }
@keyframes piscar{ 0%{background:#7f1d1d;} 50%{background:#dc2626;} 100%{background:#7f1d1d;} }

#alerta-mercado {
  position: fixed; top: 32px; left: 8px; width: 280px;
  background: #ffffff; border-left: 5px solid #c00000;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  font-family: Arial, sans-serif; font-size: 12px; z-index: 9999;
}
.alerta-header { background: #c00000; color: #fff; font-weight: bold; text-align: center; padding: 6px; font-size: 11px; }
#alerta-conteudo { padding: 8px; line-height: 1.3; }
.piscar { animation: pisca 1s infinite; }
@keyframes pisca { 0% { background: #ffffff; } 50% { background: #ffe5e5; } 100% { background: #ffffff; } }
</style>
</head>
<body>

<header>
<h2>Risco x Seguran√ßa ‚Äì Linha do Tempo (Tempo Real)</h2>
</header>

<div id="grafico"></div>

<!-- BREAKING NEWS -->
<div id="painel-news">
  <div class="news-header">üö® BREAKING NEWS ‚Äì Macro</div>
  <div id="newsList"><div id="aguardando" class="news-item">Aguardando not√≠cias...</div></div>
</div>

<audio id="alertSound" src="https://assets.mixkit.co/sfx/preview/mixkit-alert-alarm-1005.mp3"></audio>

<!-- ALERTA MERCADO -->
<div id="alerta-mercado">
  <div class="alerta-header">‚ö†Ô∏è ALERTA MERCADO</div>
  <div id="alerta-conteudo">Aguardando not√≠cias...</div>
</div>
<audio id="alerta-som" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<script>
// ===== HOR√ÅRIO BRAS√çLIA =====
function agoraBrasilia(){
    const agora = new Date();
    const offset = -3;
    const utc = agora.getTime() + (agora.getTimezoneOffset()*60000);
    return new Date(utc + (3600000*offset));
}

// ===== Ativos reais via Yahoo Finance =====
let ativosRisco = [
  {nome:"Ouro Futuros", simbolo:"GC=F", valor:0},
  {nome:"Petr√≥leo WTI", simbolo:"CL=F", valor:0},
  {nome:"Vale SA ADR", simbolo:"VALE", valor:0},
  {nome:"Petrobras ADR", simbolo:"PBR", valor:0},
  {nome:"Cobre Futuros", simbolo:"HG=F", valor:0}
];
let ativosSeguranca = [
  {nome:"DXY - √çndice D√≥lar", simbolo:"DX-Y.NYB", valor:0},
  {nome:"EUR/BRL", simbolo:"EURBRL=X", valor:0},
  {nome:"S&P 500 VIX", simbolo:"^VIX", valor:0},
  {nome:"USD/MXN", simbolo:"USDMXN=X", valor:0},
  {nome:"USD/NOK", simbolo:"USDNOK=X", valor:0}
];

// ===== Hist√≥rico =====
let datas=[], riscoHist=[], seguroHist=[];

// ===== Atualiza cota√ß√µes reais =====
async function atualizarCotacoesReais(){
    const symbols = [...ativosRisco,...ativosSeguranca].map(a=>a.simbolo).join(",");
    const url = `https://yfapi.net/v6/finance/quote?symbols=${symbols}`;
    try{
        const res = await fetch(url,{
            method:"GET",
            headers:{"X-API-KEY":"SUA_CHAVE_RAPIDAPI_AQUI"} // Substitua pela sua chave
        });
        const data = await res.json();

        ativosRisco.forEach(a=>{
            const info = data.quoteResponse.result.find(q=>q.symbol===a.simbolo);
            if(info){
                let antigo = a.valor || info.regularMarketPrice;
                a.valor = info.regularMarketPrice;
                a.variacao = ((a.valor-antigo)/antigo)*100;
            }
        });

        ativosSeguranca.forEach(a=>{
            const info = data.quoteResponse.result.find(q=>q.symbol===a.simbolo);
            if(info){
                let antigo = a.valor || info.regularMarketPrice;
                a.valor = info.regularMarketPrice;
                a.variacao = ((a.valor-antigo)/antigo)*100;
            }
        });

        atualizarGrafico();
    }catch(e){ console.error("Erro ao atualizar cota√ß√µes:", e); }
}

// ===== Inicializa gr√°fico =====
function atualizarGrafico(){
    const agora = agoraBrasilia();
    datas.push(agora);

    let valR = ativosRisco.reduce((acc,a)=>acc+a.valor,0)/ativosRisco.length;
    let valS = ativosSeguranca.reduce((acc,a)=>acc+a.valor,0)/ativosSeguranca.length;

    riscoHist.push(valR);
    seguroHist.push(valS);

    if(datas.length>100){ datas.shift(); riscoHist.shift(); seguroHist.shift(); }

    Plotly.react('grafico',[
        {x:datas, y:riscoHist, mode:'lines+markers', name:'Risco', line:{color:'green'}},
        {x:datas, y:seguroHist, mode:'lines+markers', name:'Seguran√ßa', line:{color:'red'}}
    ],{
        title:'Linha do Tempo Risco x Seguran√ßa',
        xaxis:{title:'Hor√°rio (BR)', type:'date', rangeslider:{visible:false}},
        yaxis:{title:'Valor'},
        margin:{t:40,l:50,r:50,b:50},
        legend:{x:1,xanchor:'right',y:1}
    });
}

// ===== Inicializa√ß√£o =====
async function iniciarDashboard(){
    // Preenche hist√≥rico inicial com os √∫ltimos 12 pontos (12h simuladas)
    const agora = agoraBrasilia();
    datas=[]; riscoHist=[]; seguroHist=[];
    for(let i=12;i>0;i--){
        let past = new Date(agora.getTime() - i*60*60*1000);
        datas.push(past);
        riscoHist.push(0);
        seguroHist.push(0);
    }
    await atualizarCotacoesReais();
    setInterval(atualizarCotacoesReais, 60000); // Atualiza a cada 60s
}
iniciarDashboard();
window.addEventListener('resize',()=>{ Plotly.Plots.resize('grafico'); });

// ===== BREAKING NEWS =====
const palavras = ["fed","cpi","juros","taxa","guerra","war","infla√ß√£o","inflation","banco central","central bank"];
const lista = document.getElementById("newsList");
const painel = document.getElementById("painel-news");
const header = document.querySelector(".news-header");
const som = document.getElementById("alertSound");
let cache = {}; let alertaAtivo=false;

async function buscarNoticias(){
  const query = palavras.join(" OR ");
  const rss = "https://news.google.com/rss/search?q=" + encodeURIComponent(query) + "&hl=pt-BR&gl=BR&ceid=BR:pt";
  const url = "https://api.allorigins.win/raw?url=" + encodeURIComponent(rss);
  try{
    const res = await fetch(url); const text = await res.text();
    const xml = new DOMParser().parseFromString(text,"text/xml");
    const items = xml.querySelectorAll("item");
    items.forEach(item=>{
        const titulo=item.querySelector("title")?.textContent||"";
        const link=item.querySelector("link")?.textContent||"";
        if(!titulo || cache[link]) return;
        const t=titulo.toLowerCase();
        if(!palavras.some(p=>t.includes(p))) return;
        cache[link]=true;
        document.getElementById("aguardando")?.remove();
        const div=document.createElement("div");
        div.className="news-item";
        div.innerHTML=`<strong>üö® ${titulo}</strong><br><a href="${link}" target="_blank">Ler not√≠cia</a>`;
        lista.prepend(div);
        if(!alertaAtivo){
            alertaAtivo=true;
            painel.classList.add("breaking"); header.classList.add("breaking");
            som.play().catch(()=>{});
            setTimeout(()=>{painel.classList.remove("breaking"); header.classList.remove("breaking"); alertaAtivo=false;},12000);
        }
    });
  }catch(e){console.error("Erro news:",e);}
}
buscarNoticias(); setInterval(buscarNoticias,30000);

// ===== ALERTA MERCADO =====
const alertaConteudo = document.getElementById("alerta-conteudo");
const alertaBox = document.getElementById("alerta-mercado");
const alertaSom = document.getElementById("alerta-som");
const rssUrl = "https://news.google.com/rss/search?q=presidente+EUA+OR+presidente+Brasil+juros+mercado+financeiro&hl=pt-BR&gl=BR&ceid=BR:pt";
const proxy = "https://api.allorigins.win/raw?url=";
let ultimaNoticia = "";
async function buscarNoticiasAlerta(){
    try{
        const res = await fetch(proxy + encodeURIComponent(rssUrl));
        const texto = await res.text();
        const xml = new DOMParser().parseFromString(texto,"text/xml");
        const item = xml.querySelector("item");
        if(!item) return;
        const titulo=item.querySelector("title").textContent;
        const link=item.querySelector("link").textContent;
        if(titulo!==ultimaNoticia){
            ultimaNoticia=titulo;
            alertaConteudo.innerHTML='üì∞ <a href="'+link+'" target="_blank" style="color:#000;text-decoration:none;">'+titulo+'</a>';
            alertaBox.classList.add("piscar"); alertaSom.play().catch(()=>{});
            setTimeout(()=>alertaBox.classList.remove("piscar"),15000);
        }
    }catch(e){console.log("Erro ao buscar not√≠cias alerta");}
}
buscarNoticiasAlerta(); setInterval(buscarNoticiasAlerta,60000);
</script>
</body>
</html>
