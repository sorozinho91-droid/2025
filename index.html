<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Direção Intraday do Dólar</title>

<script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>

<style>
body{
  background:#0e0e0e;
  color:#e0e0e0;
  font-family:Arial, Helvetica, sans-serif;
  margin:20px;
}
#grafico{
  width:100%;
  height:500px;
  background:#111;
  border-radius:8px;
}
#sinal{
  font-size:22px;
  font-weight:bold;
  margin-top:10px;
}
.compra{color:#00c853}
.venda{color:#d50000}
.neutro{color:#ffeb3b}
</style>
</head>

<body>

<h2>Direção Intraday do Dólar</h2>
<p>Risco × Segurança • Atualização automática a cada 60s</p>

<div id="grafico"></div>
<div id="sinal" class="neutro">SINAL: NEUTRO</div>

<script>
/* =========================
   API
========================= */
const API_KEY = "d58a789r01qptoar8c7gd58a789r01qptoar8c80";
const INTERVALO = "1min";

/* =========================
   ATIVOS
========================= */
const risco = [
  "XAU/USD","HG","CL","EWZ","VALE","PBR",
  "XLF","XLP","XLE","XME","EEM","SOXX"
];

const seguranca = [
  "DXY","USD/NOK","USD/AUD","USD/NZD",
  "USD/KRW","USD/CNY","EUR/BRL"
];

/* =========================
   FUNÇÃO ÚNICA OTIMIZADA
========================= */
async function direcao(symbol){
  const url = `https://api.twelvedata.com/time_series?symbol=${symbol}&interval=${INTERVALO}&outputsize=2&apikey=${API_KEY}`;
  try{
    const r = await fetch(url);
    const d = await r.json();
    if(!d.values || d.values.length<2) return 0;
    return d.values[0].close > d.values[1].close ? 1 :
           d.values[0].close < d.values[1].close ? -1 : 0;
  }catch{
    return 0;
  }
}

/* =========================
   SCORE MÉDIO
========================= */
async function score(lista){
  let s=0,t=0;
  for(const a of lista){
    const d = await direcao(a);
    if(d!==0){ s+=d; t++; }
  }
  return t? +(s/t).toFixed(2):0;
}

/* =========================
   GRÁFICO
========================= */
const chart = echarts.init(document.getElementById("grafico"));
let x=[], r=[], s=[], diff=[];

async function atualizar(){
  const h = new Date().toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});
  const vr = await score(risco);
  const vs = await score(seguranca);
  const vd = +(vs - vr).toFixed(2);

  x.push(h); r.push(vr); s.push(vs); diff.push(vd);
  if(x.length>120){ x.shift(); r.shift(); s.shift(); diff.shift(); }

  // SINAL
  const sinal = document.getElementById("sinal");
  if(vd > 0.25){
    sinal.textContent = "SINAL: COMPRA DÓLAR";
    sinal.className = "compra";
  }else if(vd < -0.25){
    sinal.textContent = "SINAL: VENDA DÓLAR";
    sinal.className = "venda";
  }else{
    sinal.textContent = "SINAL: NEUTRO";
    sinal.className = "neutro";
  }

  chart.setOption({
    backgroundColor:"#111",
    tooltip:{trigger:"axis"},
    legend:{
      data:["Risco","Segurança","Diferença"],
      textStyle:{color:"#ccc"}
    },
    xAxis:{
      type:"category",
      data:x,
      axisLabel:{color:"#aaa"}
    },
    yAxis:{
      min:-1,
      max:1,
      splitLine:{lineStyle:{color:"#222"}},
      axisLabel:{color:"#aaa"}
    },
    series:[
      {name:"Risco",type:"line",smooth:true,data:r,lineStyle:{color:"#00c853"}},
      {name:"Segurança",type:"line",smooth:true,data:s,lineStyle:{color:"#d50000"}},
      {name:"Diferença",type:"line",smooth:true,data:diff,lineStyle:{color:"#ffeb3b",width:3}}
    ]
  });
}

/* =========================
   LOOP 60s
========================= */
atualizar();
setInterval(atualizar,60000);
</script>

</body>
</html>
