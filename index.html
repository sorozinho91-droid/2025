<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sentimento de Mercado â€“ Risco x SeguranÃ§a</title>

<script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>

<style>
html, body {
    margin: 0;
    width: 100%;
    height: 100%;
    background: #0e0e0e;
    color: #eee;
    font-family: Arial, sans-serif;
}
#wrapper {
    height: 100%;
    display: flex;
    flex-direction: column;
}
h2 {
    margin: 0;
    padding: 10px;
}
#legend {
    display: flex;
    gap: 20px;
    padding: 6px 12px;
    font-size: 14px;
}
.legend {
    display: flex;
    align-items: center;
    gap: 6px;
}
.box {
    width: 12px;
    height: 12px;
}
.green { background:#00ff88; }
.red { background:#ff4444; }

#chart {
    flex: 1;
    min-height: 200px;
}
</style>
</head>

<body>

<div id="wrapper">
    <h2>ğŸ“Š Sentimento de Mercado â€“ DireÃ§Ã£o do Dia</h2>

    <div id="legend">
        <div class="legend">
            <div class="box green"></div> RISCO (Risk-On)
        </div>
        <div class="legend">
            <div class="box red"></div> SEGURANÃ‡A (Risk-Off)
        </div>
    </div>

    <div id="chart"></div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

    /* â”€â”€â”€â”€â”€ HORÃRIO DE BRASÃLIA (UTC-3) â”€â”€â”€â”€â”€ */
    function nowBrasilia() {
        return Math.floor(Date.now() / 1000) - 3 * 60 * 60;
    }

    const container = document.getElementById("chart");

    /* â”€â”€â”€â”€â”€ CRIA GRÃFICO â”€â”€â”€â”€â”€ */
    const chart = LightweightCharts.createChart(container, {
        layout: {
            background: { color: "#0e0e0e" },
            textColor: "#cccccc"
        },
        grid: {
            vertLines: { visible: false },
            horzLines: { visible: false }
        },
        timeScale: {
            timeVisible: true,
            secondsVisible: false
        }
    });

    const riskSeries = chart.addLineSeries({
        color: "#00ff88",
        lineWidth: 3
    });

    const safetySeries = chart.addLineSeries({
        color: "#ff4444",
        lineWidth: 3
    });

    /* â”€â”€â”€â”€â”€ PARÃ‚METROS â”€â”€â”€â”€â”€ */
    const MINUTES = 390;
    let risk = 100;
    let safety = 100;

    const riskData = [];
    const safetyData = [];

    function step(v, vol) {
        return v * (1 + (Math.random() - 0.5) * vol);
    }

    /* â”€â”€â”€â”€â”€ HISTÃ“RICO INICIAL â”€â”€â”€â”€â”€ */
    let t = nowBrasilia() - MINUTES * 60;

    for (let i = 0; i < MINUTES; i++) {
        risk = step(risk, 0.002);
        safety = step(safety, 0.0015);

        riskData.push({ time: t, value: risk });
        safetyData.push({ time: t, value: safety });
        t += 60;
    }

    riskSeries.setData(riskData);
    safetySeries.setData(safetyData);
    chart.timeScale().scrollToRealTime();

    /* â”€â”€â”€â”€â”€ ATUALIZA A CADA 1 MINUTO â”€â”€â”€â”€â”€ */
    setInterval(() => {
        const time = nowBrasilia();

        risk = step(risk, 0.003);
        safety = step(safety, 0.0018);

        const rPoint = { time, value: risk };
        const sPoint = { time, value: safety };

        riskData.push(rPoint);
        safetyData.push(sPoint);

        if (riskData.length > MINUTES) {
            riskData.shift();
            safetyData.shift();
        }

        riskSeries.update(rPoint);
        safetySeries.update(sPoint);

        chart.timeScale().scrollToRealTime();
    }, 60000);

    /* â”€â”€â”€â”€â”€ AJUSTE AO MINIMIZAR / RESTAURAR â”€â”€â”€â”€â”€ */

    function resizeChart() {
        if (container.clientWidth > 0 && container.clientHeight > 0) {
            chart.resize(container.clientWidth, container.clientHeight);
            chart.timeScale().scrollToRealTime();
        }
    }

    // ResizeObserver (principal)
    const resizeObserver = new ResizeObserver(() => {
        requestAnimationFrame(resizeChart);
    });
    resizeObserver.observe(container);

    // Quando a aba perde e recupera foco
    document.addEventListener("visibilitychange", () => {
        if (!document.hidden) {
            setTimeout(resizeChart, 50);
        }
    });

    // Quando a janela Ã© restaurada
    window.addEventListener("focus", () => {
        setTimeout(resizeChart, 50);
    });

    // Fallback clÃ¡ssico
    window.addEventListener("resize", resizeChart);

});
</script>

</body>
</html>
