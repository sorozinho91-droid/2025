<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Dashboard – Ativos de Risco x Seguros</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    background: #f4f6f8;
}
header {
    background: #1f2937;
    color: white;
    padding: 15px;
    text-align: center;
}
#controls, #date-controls {
    text-align: center;
    padding: 10px;
}
button {
    margin: 5px;
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    background: #e5e7eb;
}
button.active {
    background: #2563eb;
    color: white;
}
#grafico {
    width: 100%;
    height: 500px;
}
input[type="datetime-local"] {
    margin: 0 5px;
    padding: 5px;
}
</style>
</head>
<body>

<header>
    <h2>Ativos de Risco x Seguros – Dashboard</h2>
</header>

<div id="controls">
    <button onclick="setTimeframe(0.5, this)">30s</button>
    <button onclick="setTimeframe(1, this)" class="active">1m</button>
    <button onclick="setTimeframe(5, this)">5m</button>
    <button onclick="setTimeframe(15, this)">15m</button>
    <button onclick="setTimeframe(60, this)">1h</button>
</div>

<div id="date-controls">
    <label>De: <input type="datetime-local" id="startDate"></label>
    <label>Até: <input type="datetime-local" id="endDate"></label>
    <button onclick="filtrarDatas()">Comparar</button>
</div>

<div id="grafico"></div>

<script>
/* ================== VARIÁVEIS ================== */
let timeframe = 1; // minutos
let timer = null;

let datas = [];
let risco = [];
let seguro = [];

let valorRisco = 100;
let valorSeguro = 100;
const pontosHistorico = 120; // número de pontos do histórico

/* ================== FUNÇÕES ================== */
function atualizarValores(valor, volatilidade) {
    return Math.max(0, valor + (Math.random() - 0.5) * volatilidade);
}

function gerarHistorico(pontos) {
    let datasHist = [];
    let riscoHist = [];
    let seguroHist = [];

    let valorRiscoHist = 100;
    let valorSeguroHist = 100;

    const agora = new Date();

    for (let i = pontos - 1; i >= 0; i--) {
        const hora = new Date(agora - i * timeframe * 60000);
        const horaFormatada = hora.toLocaleTimeString();

        valorRiscoHist = atualizarValores(valorRiscoHist, 2);
        valorSeguroHist = atualizarValores(valorSeguroHist, 0.5);

        datasHist.push(horaFormatada);
        riscoHist.push(valorRiscoHist);
        seguroHist.push(valorSeguroHist);
    }

    return { datasHist, riscoHist, seguroHist, valorRiscoHist, valorSeguroHist };
}

function atualizarGrafico() {
    const hora = new Date().toLocaleTimeString();

    valorRisco = atualizarValores(valorRisco, 2);
    valorSeguro = atualizarValores(valorSeguro, 0.5);

    datas.push(hora);
    risco.push(valorRisco);
    seguro.push(valorSeguro);

    if (datas.length > pontosHistorico) {
        datas.shift();
        risco.shift();
        seguro.shift();
    }

    Plotly.extendTraces('grafico', {
        x: [[hora], [hora]],
        y: [[valorRisco], [valorSeguro]]
    }, [0, 1], pontosHistorico);
}

function setTimeframe(minutos, botao) {
    timeframe = minutos;

    document.querySelectorAll('#controls button').forEach(b => b.classList.remove('active'));
    botao.classList.add('active');

    if (timer) clearInterval(timer);
    timer = setInterval(atualizarGrafico, timeframe * 60000);
}

// Filtrar gráfico entre duas datas
function filtrarDatas() {
    const start = new Date(document.getElementById('startDate').value);
    const end = new Date(document.getElementById('endDate').value);

    if (!start || !end || start > end) {
        alert('Selecione datas válidas!');
        return;
    }

    const filteredX = [];
    const filteredRisco = [];
    const filteredSeguro = [];

    for (let i = 0; i < datas.length; i++) {
        const horaParts = datas[i].split(':');
        const now = new Date();
        now.setHours(horaParts[0], horaParts[1], horaParts[2]);
        if (now >= start && now <= end) {
            filteredX.push(datas[i]);
            filteredRisco.push(risco[i]);
            filteredSeguro.push(seguro[i]);
        }
    }

    Plotly.update('grafico', {
        x: [filteredX, filteredX],
        y: [filteredRisco, filteredSeguro]
    });
}

/* ================== INICIALIZAÇÃO ================== */
const historico = gerarHistorico(pontosHistorico);
datas = historico.datasHist;
risco = historico.riscoHist;
seguro = historico.seguroHist;
valorRisco = historico.valorRiscoHist;
valorSeguro = historico.valorSeguroHist;

const layout = {
    title: 'Comparação em Tempo Real',
    xaxis: { title: 'Hora' },
    yaxis: { title: 'Valor' },
    margin: { t: 50 }
};

Plotly.newPlot('grafico', [
    { x: datas, y: risco, mode: 'lines', name: 'Ativos de Risco', line: { color: 'red' } },
    { x: datas, y: seguro, mode: 'lines', name: 'Ativos Seguros', line: { color: 'green' } }
], layout, { responsive: true });

timer = setInterval(atualizarGrafico, timeframe * 60000);

window.addEventListener('resize', () => {
    Plotly.Plots.resize('grafico');
});
</script>

</body>
</html>
