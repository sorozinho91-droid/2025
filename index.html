<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Risco x Segurança – Intraday Dólar</title>

<script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>

<style>
body{
  background:#0e0e0e;
  color:#e0e0e0;
  font-family:Arial, Helvetica, sans-serif;
  margin:20px;
}
#grafico{
  width:100%;
  height:520px;
  background:#111;
  border-radius:8px;
}
h2{margin-bottom:5px}
p{color:#aaa;margin-top:0}
</style>
</head>

<body>

<h2>Direção Intraday do Dólar</h2>
<p>Histórico do dia + atualização automática a cada 60s</p>

<div id="grafico"></div>

<script>
/* =========================
   API
========================= */
const API_KEY = "d58a789r01qptoar8c7gd58a789r01qptoar8c80";
const INTERVALO = "1min";

/* =========================
   ATIVOS
========================= */
const ativosRisco = [
  "XAU/USD","HG","CL","EWZ","VALE","PBR",
  "XLF","XLP","XLE","XME","EEM","SOXX"
];

const ativosSeguranca = [
  "DXY","USD/NOK","USD/AUD","USD/NZD",
  "USD/KRW","USD/CNY","EUR/BRL"
];

/* =========================
   BUSCA SÉRIE INTRADAY
========================= */
async function serie(symbol){
  const url = `https://api.twelvedata.com/time_series?symbol=${symbol}&interval=${INTERVALO}&outputsize=390&apikey=${API_KEY}`;
  try{
    const r = await fetch(url);
    const d = await r.json();
    return d.values ? d.values.reverse() : [];
  }catch{
    return [];
  }
}

/* =========================
   CALCULA SCORE HISTÓRICO
========================= */
async function gerarHistorico(){
  const base = await serie(ativosSeguranca[0]);
  let horas=[], risco=[], seguranca=[];

  for(let i=1;i<base.length;i++){
    let sr=0,tr=0,ss=0,ts=0;

    for(const a of ativosRisco){
      const s = await serie(a);
      if(s[i] && s[i-1]){
        const d = s[i].close > s[i-1].close ? 1 : s[i].close < s[i-1].close ? -1 : 0;
        if(d!==0){ sr+=d; tr++; }
      }
    }

    for(const a of ativosSeguranca){
      const s = await serie(a);
      if(s[i] && s[i-1]){
        const d = s[i].close > s[i-1].close ? 1 : s[i].close < s[i-1].close ? -1 : 0;
        if(d!==0){ ss+=d; ts++; }
      }
    }

    horas.push(base[i].datetime.slice(11,16));
    risco.push(tr? +(sr/tr).toFixed(2):0);
    seguranca.push(ts? +(ss/ts).toFixed(2):0);
  }

  return {horas, risco, seguranca};
}

/* =========================
   GRÁFICO
========================= */
const chart = echarts.init(document.getElementById("grafico"));

async function iniciar(){
  const h = await gerarHistorico();

  chart.setOption({
    backgroundColor:"#111",
    tooltip:{trigger:"axis"},
    legend:{
      data:["Ativos de Risco","Ativos de Segurança"],
      textStyle:{color:"#ccc"}
    },
    xAxis:{
      type:"category",
      data:h.horas,
      axisLabel:{color:"#aaa"}
    },
    yAxis:{
      min:-1,
      max:1,
      splitLine:{lineStyle:{color:"#222"}},
      axisLabel:{color:"#aaa"}
    },
    series:[
      {
        name:"Ativos de Risco",
        type:"line",
        smooth:true,
        data:h.risco,
        lineStyle:{width:2,color:"#00c853"}
      },
      {
        name:"Ativos de Segurança",
        type:"line",
        smooth:true,
        data:h.seguranca,
        lineStyle:{width:2,color:"#d50000"}
      }
    ]
  });
}

/* =========================
   START
========================= */
iniciar();
</script>

</body>
</html>
