<!DOCTYPE html>
<html>
<head>
    <title>Ativos Risco x Segurança (Real)</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
<h2>Ativos Risco x Segurança (Atualização Automática com dados reais)</h2>

<label>Selecionar Time Frame: </label>
<select id="timeframe" onchange="updateInterval()">
    <option value="30000">30 segundos</option>
    <option value="60000">1 minuto</option>
</select>

<div id="grafico" style="width:100%;height:600px;"></div>

<script>
    // Ativos e códigos Yahoo Finance
    const ativos_risco = [
        {nome:"Ouro Futuros", codigo:"GC=F"},
        {nome:"Cobre Futuros", codigo:"HG=F"},
        {nome:"Petróleo WTI", codigo:"CL=F"},
        {nome:"Dow Jones Futuros", codigo:"YM=F"},
        {nome:"Vale SA ADR", codigo:"VALE.K"},
        {nome:"Petrobras SA ADR", codigo:"PBR"}
    ];

    const ativos_seguranca = [
        {nome:"Índice Dólar", codigo:"DX-Y.NYB"},
        {nome:"VIX", codigo:"^VIX"},
        {nome:"USD/MXN", codigo:"MXN=X"},
        {nome:"EUR/BRL", codigo:"EURBRL=X"}
    ];

    let data = [];

    // Inicializa o gráfico com valores fictícios
    const now = new Date();
    function initData() {
        ativos_risco.forEach(a => {
            data.push({x:[now], y:[0], name:a.nome, mode:'lines', line:{color:'red', dash:'dash'}});
        });
        ativos_seguranca.forEach(a => {
            data.push({x:[now], y:[0], name:a.nome, mode:'lines', line:{color:'blue'}});
        });
    }

    initData();

    const layout = {title:'Ativos Risco x Segurança', xaxis:{title:'Data/Hora'}, yaxis:{title:'Valor'}, legend:{orientation:"h"}};
    Plotly.newPlot('grafico', data, layout);

    // Atualização automática
    let intervalTime = 30000; // 30s padrão
    let intervalID = setInterval(updateData, intervalTime);

    function fetchPrecoYahoo(codigo) {
        // Endpoint Yahoo Finance JSON não oficial
        const url = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${codigo}`;
        return fetch(url)
            .then(response => response.json())
            .then(json => {
                const price = json.quoteResponse.result[0].regularMarketPrice;
                return price;
            })
            .catch(err => { console.log("Erro ao buscar", codigo, err); return null; });
    }

    async function updateData() {
        const now = new Date();
        // Atualiza ativos de risco
        for(let i=0; i<ativos_risco.length; i++){
            const preco = await fetchPrecoYahoo(ativos_risco[i].codigo);
            if(preco!==null){
                data[i].x.push(now);
                data[i].y.push(preco);
                if(data[i].x.length>20){ data[i].x.shift(); data[i].y.shift(); }
            }
        }
        // Atualiza ativos de segurança
        for(let i=0; i<ativos_seguranca.length; i++){
            const preco = await fetchPrecoYahoo(ativos_seguranca[i].codigo);
            if(preco!==null){
                const idx = i + ativos_risco.length;
                data[idx].x.push(now);
                data[idx].y.push(preco);
                if(data[idx].x.length>20){ data[idx].x.shift(); data[idx].y.shift(); }
            }
        }
        Plotly.update('grafico', data);
    }

    function updateInterval() {
        clearInterval(intervalID);
        intervalTime = parseInt(document.getElementById("timeframe").value);
        intervalID = setInterval(updateData, intervalTime);
    }
</script>
</body>
</html>
