<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Direção Intraday - Risco x Segurança</title>
<script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
<style>
body {
  background:#0e0e0e;
  color:#e0e0e0;
  font-family:Arial, Helvetica, sans-serif;
  margin:20px;
}
#grafico {
  width:100%;
  height:520px;
  background:#111;
  border-radius:8px;
}
#sinal {
  font-size:22px;
  font-weight:bold;
  margin-top:10px;
}
.compra{color:#00c853}
.venda{color:#d50000}
.neutro{color:#ffeb3b}
</style>
</head>
<body>

<h2>Direção Intraday - Ativos de Risco x Segurança</h2>
<p>Atualização a cada 60s • Histórico intraday</p>

<div id="grafico"></div>
<div id="sinal" class="neutro">SINAL: AGUARDANDO DADOS…</div>

<script>
const chart = echarts.init(document.getElementById("grafico"));

// Histórico intraday
let eixoX = [];
let ativosSeguranca = ["USD-BRL","Ouro"];
let ativosRisco = ["BTC-BRL","ETF-ACAO"];
let ultimoValores = {};
let serieRisco = [];
let serieSeguranca = [];

/* =========================
   Função para pegar preço real ou simulado
========================= */
async function pegarValorAtivo(ativo){
  try{
    if(ativo === "USD-BRL"){
      const res = await fetch('https://economia.awesomeapi.com.br/json/last/USD-BRL');
      const data = await res.json();
      return parseFloat(data.USDBRL.bid);
    } else if(ativo === "BTC-BRL"){
      const res = await fetch('https://economia.awesomeapi.com.br/json/last/BTC-BRL');
      const data = await res.json();
      return parseFloat(data.BTCBRL.bid);
    } else if(ativo === "Ouro"){
      return 325 + Math.random()*2-1; // simulado
    } else if(ativo === "ETF-ACAO"){
      return 100 + Math.random()*2-1; // simulado
    }
  } catch(err){
    console.error("Erro ao buscar ativo", ativo, err);
    return null;
  }
}

/* =========================
   Calcula direção de cada grupo
========================= */
function calcularDirecao(ativos){
  let soma = 0;
  let count = 0;
  for(let ativo of ativos){
    const valor = ultimoValores[ativo];
    if(valor !== undefined){
      const delta = valor - ultimoValores[ativo+"_anterior"];
      if(ultimoValores[ativo+"_anterior"] !== undefined){
        soma += delta;
        count++;
      }
      ultimoValores[ativo+"_anterior"] = valor;
    }
  }
  if(count === 0) return 0;
  return soma / count; // direção média do grupo
}

/* =========================
   Atualiza gráfico intraday
========================= */
async function atualizarGrafico(){
  const hora = new Date().toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit",second:"2-digit"});
  eixoX.push(hora);
  if(eixoX.length>480) eixoX.shift(); // histórico intraday

  // Atualiza valores atuais
  for(let ativo of ativosSeguranca.concat(ativosRisco)){
    const valor = await pegarValorAtivo(ativo);
    if(valor!==null) ultimoValores[ativo] = valor;
  }

  // Calcula direção dos grupos
  const dirSeg = calcularDirecao(ativosSeguranca);
  const dirRisco = calcularDirecao(ativosRisco);

  serieSeguranca.push(dirSeg);
  serieRisco.push(dirRisco);

  if(serieSeguranca.length>480){ serieSeguranca.shift(); serieRisco.shift(); }

  // Atualiza sinal
  const sinal = document.getElementById("sinal");
  if(dirSeg - dirRisco > 0){ sinal.textContent="SINAL: SEGURANÇA DOMINANTE"; sinal.className="compra"; }
  else if(dirSeg - dirRisco < 0){ sinal.textContent="SINAL: RISCO DOMINANTE"; sinal.className="venda"; }
  else{ sinal.textContent="SINAL: NEUTRO"; sinal.className="neutro"; }

  // Atualiza gráfico
  chart.setOption({
    backgroundColor:"#111",
    tooltip:{trigger:"axis", formatter: params=>{
      return params.map(p=>`${p.seriesName}: ${p.data.toFixed(4)}`).join("<br>");
    }},
    legend:{data:["Segurança","Risco"], textStyle:{color:"#ccc"}},
    xAxis:{type:"category", data:eixoX, axisLabel:{color:"#aaa"}},
    yAxis:{scale:true, axisLabel:{color:"#aaa"}, splitLine:{lineStyle:{color:"#222"}}},
    series:[
      {name:"Segurança", type:"line", smooth:true, showSymbol:false, data:serieSeguranca, lineStyle:{width:2,type:"dashed",color:"#00c853"}},
      {name:"Risco", type:"line", smooth:true, showSymbol:false, data:serieRisco, lineStyle:{width:2,color:"#d50000"}}
    ]
  });
}

// Inicializa loop automático a cada 60 segundos
atualizarGrafico();
setInterval(atualizarGrafico,60000);

</script>

</body>
</html>
