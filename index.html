<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Ativos de Risco x Segurança - Diário</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        #grafico { width: 90%; height: 500px; margin: auto; }
    </style>
</head>
<body>

<h2>Ativos de Risco x Seguros - Acumulado Diário</h2>
<div id="grafico"></div>

<script>
/* ================= CONFIGURAÇÃO ================= */
const hoje = new Date().toISOString().slice(0, 10);
const STORAGE_KEY = "dadosGraficoDiario";

/* ================= CARREGAR DADOS ================= */
let dadosSalvos = JSON.parse(localStorage.getItem(STORAGE_KEY));

let datas = [];
let risco = [];
let seguro = [];
let valor_risco = 100;
let valor_seguro = 100;

if (dadosSalvos && dadosSalvos.data === hoje) {
    datas = dadosSalvos.datas;
    risco = dadosSalvos.risco;
    seguro = dadosSalvos.seguro;
    valor_risco = risco[risco.length - 1] ?? 100;
    valor_seguro = seguro[seguro.length - 1] ?? 100;
} else {
    dadosSalvos = {
        data: hoje,
        datas: [],
        risco: [],
        seguro: []
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(dadosSalvos));
}

/* ================= GRÁFICO INICIAL ================= */
const traceRisco = {
    x: datas,
    y: risco,
    type: 'scatter',
    mode: 'lines',
    name: 'Ativos de Risco',
};

const traceSeguro = {
    x: datas,
    y: seguro,
    type: 'scatter',
    mode: 'lines',
    name: 'Ativos Seguros',
};

Plotly.newPlot('grafico', [traceRisco, traceSeguro], {
    title: 'Acumulado do Dia',
    xaxis: { title: 'Hora' },
    yaxis: { title: 'Valor' }
});

/* ================= FUNÇÕES ================= */
function atualizarValores(valor) {
    return Math.max(0, valor + (Math.random() - 0.5) * 2);
}

function salvarDados() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify({
        data: hoje,
        datas: datas,
        risco: risco,
        seguro: seguro
    }));
}

/* ================= LOOP TEMPO REAL ================= */
setInterval(() => {
    const agora = new Date().toLocaleTimeString();

    valor_risco = atualizarValores(valor_risco);
    valor_seguro = atualizarValores(valor_seguro);

    datas.push(agora);
    risco.push(valor_risco);
    seguro.push(valor_seguro);

    Plotly.extendTraces('grafico', {
        x: [[agora], [agora]],
        y: [[valor_risco], [valor_seguro]]
    }, [0, 1]);

    salvarDados();
}, 2000);
</script>

</body>
</html>
