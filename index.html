<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Dashboard – Linha do Tempo Risco x Segurança</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
body { font-family: Arial, sans-serif; margin:0; background:#f4f6f8; }
header { background:#1f2937; color:white; padding:15px; text-align:center; }
#controls, #compareDates { text-align:center; padding:10px; }
button { margin:5px; padding:8px 16px; border:none; border-radius:4px; cursor:pointer; background:#e5e7eb; }
button.active { background:#2563eb; color:white; }
#grafico { width:90%; height:400px; margin:20px auto; background:#fff; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1);}
</style>
</head>
<body>

<header>
<h2>Risco x Segurança – Linha do Tempo (Tempo Real)</h2>
</header>

<div id="controls">
<button onclick="setTimeframe(60,this)" class="active">60s</button>
<button onclick="setTimeframe(1,this)">1m</button>
<button onclick="setTimeframe(5,this)">5m</button>
</div>

<div id="compareDates">
<label>Início: <input type="datetime-local" id="startDate"></label>
<label>Fim: <input type="datetime-local" id="endDate"></label>
<button onclick="filtrarPorData()">Comparar</button>
<button onclick="resetGrafico()">Resetar</button>
</div>

<div id="grafico"></div>

<script>
// ==== Variáveis ====
let datas = [];
let risco = [];
let seguro = [];
let valorRisco = 100;
let valorSeguro = 100;
let timer = null;
let filtered = false;
let filteredStart, filteredEnd;
let timeframe = 60; // segundos

// Gerar histórico inicial (30 dias, 1 ponto/hora)
function gerarHistorico(){
    const agora = new Date();
    const start = new Date(agora.getTime() - 30*24*60*60*1000);
    datas = []; risco = []; seguro = [];
    let valR = valorRisco;
    let valS = valorSeguro;
    for(let d=new Date(start); d<=agora; d.setHours(d.getHours()+1)){
        valR += (Math.random()-0.5)*2;
        valS += (Math.random()-0.5)*1;
        datas.push(new Date(d));
        risco.push(valR);
        seguro.push(valS);
    }
}

// Plotar gráfico
function plotGrafico(x, yR, yS){
    Plotly.react('grafico',[
        {x:x, y:yR, mode:'lines+markers', name:'Risco', line:{color:'red'}},
        {x:x, y:yS, mode:'lines+markers', name:'Segurança', line:{color:'green'}}
    ],{
        title:'Linha do Tempo Risco x Segurança',
        xaxis:{title:'Data', type:'date', rangeslider:{visible:false}}, // range slider desativado
        yaxis:{title:'Valor'},
        margin:{t:40,l:50,r:50,b:50},
        legend:{x:1,xanchor:'right',y:1}
    });
}

// Atualização em tempo real
function atualizarGrafico(){
    const agora = new Date();
    valorRisco += (Math.random()-0.5)*2;
    valorSeguro += (Math.random()-0.5)*1;
    datas.push(agora);
    risco.push(valorRisco);
    seguro.push(valorSeguro);

    // Limitar pontos para performance
    if(datas.length>1000){
        datas.shift();
        risco.shift();
        seguro.shift();
    }

    // Se filtrado, mostrar apenas intervalo
    if(filtered){
        const newD = [], newR = [], newS = [];
        for(let i=0;i<datas.length;i++){
            if(datas[i]>=filteredStart && datas[i]<=filteredEnd){
                newD.push(datas[i]);
                newR.push(risco[i]);
                newS.push(seguro[i]);
            }
        }
        plotGrafico(newD,newR,newS);
    } else {
        plotGrafico(datas,risco,seguro);
    }
}

// Filtrar por datas
function filtrarPorData(){
    filteredStart = new Date(document.getElementById('startDate').value);
    filteredEnd = new Date(document.getElementById('endDate').value);
    if(isNaN(filteredStart) || isNaN(filteredEnd)){ alert("Selecione datas válidas"); return; }
    filtered = true;
    atualizarGrafico();
}

// Resetar filtro
function resetGrafico(){
    filtered = false;
    plotGrafico(datas,risco,seguro);
}

// Alterar timeframe de atualização
function setTimeframe(segundos, botao){
    timeframe = segundos;
    document.querySelectorAll('#controls button').forEach(b=>b.classList.remove('active'));
    botao.classList.add('active');
    if(timer) clearInterval(timer);
    timer = setInterval(atualizarGrafico, timeframe*1000);
}

// Inicialização
gerarHistorico();
plotGrafico(datas,risco,seguro);
timer = setInterval(atualizarGrafico, timeframe*1000);
</script>

</body>
</html>
